# DP3 è¾“å…¥è¾“å‡ºå¸§æ•°è¯¦è§£

## ğŸ“Œ å¿«é€Ÿç­”æ¡ˆ

æ ¹æ® `robot_dp3.yaml` é…ç½®ï¼š

```yaml
horizon: 8           # é¢„æµ‹çš„æ€»æ—¶åºé•¿åº¦
n_obs_steps: 3       # è¾“å…¥è§‚æµ‹å¸§æ•°
n_action_steps: 6    # è¾“å‡ºæ‰§è¡ŒåŠ¨ä½œå¸§æ•°
```

### **è¾“å…¥ï¼š3 å¸§è§‚æµ‹**
- ç‚¹äº‘åºåˆ—: `[batch, 3, N_points, 3]`
- æœºå™¨äººçŠ¶æ€: `[batch, 3, state_dim]`

### **è¾“å‡ºï¼š6 å¸§åŠ¨ä½œ**
- åŠ¨ä½œåºåˆ—: `[batch, 6, action_dim]`

---

## ğŸ” è¯¦ç»†è§£æ

### 1ï¸âƒ£ æ ¸å¿ƒå‚æ•°å«ä¹‰

```python
horizon = 8          # æ¨¡å‹é¢„æµ‹çš„å®Œæ•´åŠ¨ä½œåºåˆ—é•¿åº¦
n_obs_steps = 3      # è¾“å…¥çš„è§‚æµ‹å†å²é•¿åº¦ï¼ˆçœ‹è¿‡å»3å¸§ï¼‰
n_action_steps = 6   # å®é™…æ‰§è¡Œçš„åŠ¨ä½œæ•°é‡ï¼ˆç”¨æœªæ¥6å¸§ï¼‰
```

### 2ï¸âƒ£ æ•°æ®æµè¯¦è§£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    è®­ç»ƒé˜¶æ®µ (Training)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è¾“å…¥åˆ°æ¨¡å‹:
  è§‚æµ‹ (Observation):
    - point_cloud: [B, 8, N, 3]  â† å®Œæ•´çš„ horizon=8 å¸§
    - agent_pos:   [B, 8, state_dim]
    
  ä½†åªä½¿ç”¨å‰ n_obs_steps=3 å¸§:
    - point_cloud[:, :3, :, :]  â†’ [B, 3, N, 3]
    - agent_pos[:, :3, :]       â†’ [B, 3, state_dim]
    
  PointNet ç¼–ç :
    [B, 3, N, 3] â†’ [B, 3, 128] â†’ flatten â†’ [B, 384]
    ä½œä¸ºæ¡ä»¶ (condition) è¾“å…¥åˆ° UNet

  åŠ¨ä½œæ ‡ç­¾ (Ground Truth):
    - action: [B, 8, action_dim]  â† å®Œæ•´çš„ horizon=8 å¸§
    
  Diffusion è®­ç»ƒ:
    - é¢„æµ‹æ•´ä¸ª [B, 8, action_dim] çš„åŠ¨ä½œåºåˆ—
    - ä½†ä¸»è¦å…³æ³¨å‰ n_action_steps=6 å¸§


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ¨ç†é˜¶æ®µ (Inference)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è¾“å…¥:
  å®æ—¶è§‚æµ‹ (æœ€è¿‘3å¸§):
    - point_cloud: [1, 3, N, 3]
    - agent_pos:   [1, 3, state_dim]

æ¨¡å‹é¢„æµ‹:
  å®Œæ•´åºåˆ—: [1, 8, action_dim]
  
æå–æ‰§è¡ŒåŠ¨ä½œ:
  start = n_obs_steps - 1 = 2  # ä»ç¬¬2å¸§å¼€å§‹ï¼ˆ0-indexedï¼‰
  end = start + n_action_steps = 2 + 6 = 8
  
  action = action_pred[:, 2:8]  â†’ [1, 6, action_dim]
  
å®é™…æ‰§è¡Œ:
  æ‰§è¡Œå‰ n_action_steps=6 å¸§åŠ¨ä½œ


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ»‘åŠ¨çª—å£æ‰§è¡Œç¤ºæ„                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ—¶é—´æ­¥:  t0   t1   t2   t3   t4   t5   t6   t7   t8   t9   t10
        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Step 1: 
  è§‚æµ‹: [o0, o1, o2]                â† è¾“å…¥3å¸§è§‚æµ‹
  é¢„æµ‹: [_, _, a2, a3, a4, a5, a6, a7]  â† é¢„æµ‹8å¸§ï¼Œå–2-7
  æ‰§è¡Œ:        [a2, a3, a4, a5, a6, a7] â† æ‰§è¡Œ6å¸§ âœ“
  
Step 2: (æ‰§è¡Œ6æ­¥åï¼Œé‡æ–°è§‚æµ‹)
  è§‚æµ‹:              [o6, o7, o8]   â† æ–°çš„3å¸§è§‚æµ‹
  é¢„æµ‹:              [_, _, a8, a9, a10, a11, a12, a13]
  æ‰§è¡Œ:                   [a8, a9, a10, a11, a12, a13] âœ“
  
æ³¨æ„: æ¯æ¬¡æ‰§è¡Œ6å¸§ï¼Œä¸horizon=8æœ‰2å¸§é‡å 
     â†’ æä¾›æ›´å¹³æ»‘çš„åŠ¨ä½œè¿‡æ¸¡
```

---

## ğŸ“Š ç»´åº¦å˜åŒ–å®Œæ•´æµç¨‹

### è®­ç»ƒæ—¶ (Training)

```python
# 1. DataLoader æ‰¹æ¬¡
batch = {
    'obs': {
        'point_cloud': torch.Size([256, 8, 1024, 3]),     # B, T, N, 3
        'agent_pos':   torch.Size([256, 8, 14])           # B, T, state_dim
    },
    'action': torch.Size([256, 8, 14])                    # B, T, action_dim
}

# 2. æå–å‰ n_obs_steps=3 å¸§è§‚æµ‹
obs_input = {
    'point_cloud': batch['obs']['point_cloud'][:, :3, :, :],  # [256, 3, 1024, 3]
    'agent_pos':   batch['obs']['agent_pos'][:, :3, :]        # [256, 3, 14]
}

# 3. Flatten æ—¶é—´ç»´åº¦ï¼Œé€å…¥ PointNet
point_cloud_flat = obs_input['point_cloud'].reshape(-1, 1024, 3)  # [768, 1024, 3]
                                                                   # 768 = 256*3

# 4. PointNet ç¼–ç 
features = PointNet(point_cloud_flat)                   # [768, 128]
features = features.reshape(256, 3, 128)                # [B, 3, 128]

# 5. ä½œä¸ºå…¨å±€æ¡ä»¶ï¼ˆå¦‚æœ obs_as_global_cond=Trueï¼‰
if obs_as_global_cond:
    global_cond = features.reshape(256, -1)             # [256, 384]  (3*128)
    
# 6. Diffusion UNet é¢„æµ‹
#    è¾“å…¥: noisy_action [256, 8, 14]
#    æ¡ä»¶: global_cond  [256, 384]
#    è¾“å‡º: predicted_action [256, 8, 14]

# 7. è®¡ç®—æŸå¤±
loss = MSE(predicted_action, batch['action'])
```

### æ¨ç†æ—¶ (Inference)

```python
# 1. ç¯å¢ƒè§‚æµ‹ (å®æ—¶è·å–æœ€è¿‘3å¸§)
obs = {
    'point_cloud': torch.Size([1, 3, 1024, 3]),   # 1 batch, 3 obs steps
    'agent_pos':   torch.Size([1, 3, 14])
}

# 2. PointNet ç¼–ç 
features = encode_observations(obs)                # [1, 384]

# 3. DDIM é‡‡æ ·
noisy_action = torch.randn(1, 8, 14)              # åˆå§‹å™ªå£°
for t in reversed(timesteps):
    noisy_action = denoise_step(noisy_action, features, t)
predicted_action = noisy_action                    # [1, 8, 14]

# 4. æå–æ‰§è¡ŒåŠ¨ä½œ
start = n_obs_steps - 1 = 2
end = start + n_action_steps = 8
action_to_execute = predicted_action[:, start:end]  # [1, 6, 14]

# 5. åå½’ä¸€åŒ–
action_to_execute = normalizer.unnormalize(action_to_execute)

# 6. æ‰§è¡ŒåŠ¨ä½œï¼ˆé€å¸§å‘é€ç»™æœºå™¨äººï¼‰
for i in range(6):
    robot.execute(action_to_execute[0, i])        # æ‰§è¡Œç¬¬ i å¸§åŠ¨ä½œ
```

---

## ğŸ¯ å…³é”®ç‚¹æ€»ç»“

### âœ… è¾“å…¥è¾“å‡º
- **è¾“å…¥**: 3 å¸§è§‚æµ‹ï¼ˆç‚¹äº‘ + çŠ¶æ€ï¼‰
- **è¾“å‡º**: 6 å¸§åŠ¨ä½œ
- **æ¨¡å‹é¢„æµ‹**: 8 å¸§åŠ¨ä½œåºåˆ—ï¼ˆä½†åªç”¨ä¸­é—´6å¸§ï¼‰

### âœ… ä¸ºä»€ä¹ˆ horizon=8 ä½†æ‰§è¡Œ6å¸§ï¼Ÿ

1. **horizon=8**: æ¨¡å‹çš„é¢„æµ‹èƒ½åŠ›ï¼ˆçœ‹å¾—æ›´è¿œï¼‰
2. **n_action_steps=6**: å®é™…æ‰§è¡Œæ•°é‡ï¼ˆé¿å…è¯¯å·®ç´¯ç§¯ï¼‰
3. **é‡å 2å¸§**: æä¾›æ›´å¹³æ»‘çš„è¿‡æ¸¡

### âœ… ç´¢å¼•è®¡ç®—
```python
# ä¸ºä»€ä¹ˆä»ç¬¬2å¸§å¼€å§‹å–ï¼Ÿ
start = n_obs_steps - 1 = 3 - 1 = 2  # å¯¹åº”æœ€åä¸€ä¸ªè§‚æµ‹å¸§çš„åŠ¨ä½œ
end = start + n_action_steps = 2 + 6 = 8

# æ‰€ä»¥å– action[2:8]ï¼Œå³ç¬¬2, 3, 4, 5, 6, 7å¸§ï¼ˆå…±6å¸§ï¼‰
```

### âœ… æ—¶é—´å¯¹é½
```
è§‚æµ‹å¸§:  o[0]  o[1]  o[2]
åŠ¨ä½œå¸§:  a[0]  a[1]  a[2]  a[3]  a[4]  a[5]  a[6]  a[7]
                       â†‘                            â†‘
                    æ‰§è¡Œå¼€å§‹                     æ‰§è¡Œç»“æŸ
                    (å¯¹åº”o[2]ä¹‹åçš„åŠ¨ä½œ)
```

---

## ğŸ”§ é…ç½®æ–‡ä»¶ä½ç½®

ä¸»é…ç½®æ–‡ä»¶: `/mnt/4T/RoboTwin/policy/DP3/3D-Diffusion-Policy/diffusion_policy_3d/config/robot_dp3.yaml`

```yaml
horizon: 8           # å¯ä¿®æ”¹: é¢„æµ‹åºåˆ—é•¿åº¦
n_obs_steps: 3       # å¯ä¿®æ”¹: è§‚æµ‹å†å²é•¿åº¦
n_action_steps: 6    # å¯ä¿®æ”¹: æ‰§è¡ŒåŠ¨ä½œæ•°é‡
```

### ä¿®æ”¹å»ºè®®
- **å¢åŠ è§‚æµ‹å¸§**: éœ€è¦æ›´å¤šå†å²ä¿¡æ¯ â†’ `n_obs_steps: 5`
- **å¢åŠ æ‰§è¡Œå¸§**: å‡å°‘é‡æ–°é¢„æµ‹é¢‘ç‡ â†’ `n_action_steps: 8`
- **å¢åŠ é¢„æµ‹é•¿åº¦**: æ›´é•¿æœŸè§„åˆ’ â†’ `horizon: 16`

âš ï¸ æ³¨æ„: ä¿®æ”¹åéœ€è¦é‡æ–°è®­ç»ƒæ¨¡å‹ï¼

---

## ğŸ“ æ•°å­¦å…³ç³»

```
å¿…é¡»æ»¡è¶³: n_action_steps â‰¤ horizon
æ¨è:     n_action_steps < horizon  (æœ‰é‡å æ›´å¹³æ»‘)
å»ºè®®:     horizon - n_action_steps â‰ˆ 2-4  (é€‚åº¦é‡å )

æ‰§è¡Œé¢‘ç‡ = n_action_steps / æ§åˆ¶é¢‘ç‡
ä¾‹å¦‚: æ§åˆ¶é¢‘ç‡ 10Hz, n_action_steps=6
     â†’ æ¯ 0.6 ç§’é‡æ–°é¢„æµ‹ä¸€æ¬¡
```

---

## ğŸ¬ å®é™…è¿è¡Œç¤ºä¾‹

å‡è®¾ beat_block_hammer ä»»åŠ¡:
- æ§åˆ¶é¢‘ç‡: 10 Hz
- n_obs_steps: 3 â†’ éœ€è¦0.3ç§’çš„å†å²
- n_action_steps: 6 â†’ æ‰§è¡Œ0.6ç§’çš„åŠ¨ä½œ

```python
# ä¼ªä»£ç 
while not done:
    # 1. æ”¶é›†æœ€è¿‘3å¸§è§‚æµ‹ (0.3ç§’)
    obs_history = robot.get_recent_obs(n=3)
    
    # 2. æ¨¡å‹é¢„æµ‹
    action_sequence = model.predict(obs_history)  # é¢„æµ‹8å¸§ï¼Œè¿”å›6å¸§
    
    # 3. æ‰§è¡Œ6å¸§åŠ¨ä½œ (0.6ç§’)
    for action in action_sequence:
        robot.execute(action)
        time.sleep(0.1)  # 10Hz
    
    # 4. å¾ªç¯ï¼ˆå·²ç»è¿‡äº†0.6ç§’ï¼Œè§‚æµ‹ä¹Ÿæ›´æ–°äº†ï¼‰
```

# éœ€æ±‚è¯´æ˜æ–‡æ¡£

## ğŸ“‹ ä½ çš„å…·ä½“è¦æ±‚

### ç›®æ ‡
åˆ›å»ºä¸€ä¸ªåŸºäº DP3 çš„æ¨¡å‹ï¼Œå®ç°ï¼š
- **è¾“å…¥**: 3å¸§ç‚¹äº‘æ•°æ® `[3, 1024, 3]` (åªç”¨XYZåæ ‡ï¼Œä¸ç”¨é¢œè‰²)
- **è¾“å‡º**: æœªæ¥6å¸§çš„åŒè‡‚æœ«ç«¯ä½å§¿å’Œå¤¹çˆªçŠ¶æ€ `[6, 8]`

---

## ğŸ¯ è¾“å…¥è¾“å‡ºæ ¼å¼è¯¦è§£

### è¾“å…¥ (Observation)
```python
{
    'point_cloud': [3, 1024, 3]  # 3å¸§å†å²ç‚¹äº‘ï¼Œæ¯å¸§1024ä¸ªç‚¹ï¼Œæ¯ç‚¹3Dåæ ‡(x,y,z)
}
```

**è¯´æ˜**:
- å–æœ€è¿‘çš„3å¸§ç‚¹äº‘
- åªä½¿ç”¨å‰3ä¸ªé€šé“ (xyzåæ ‡)
- ä¸ä½¿ç”¨å3ä¸ªé€šé“ (rgbé¢œè‰²)

---

### è¾“å‡º (Action)
```python
{
    'action': [6, 8]  # é¢„æµ‹æœªæ¥6å¸§ï¼Œæ¯å¸§8ç»´åŠ¨ä½œ
}
```

**8ç»´åŠ¨ä½œçš„ç»„æˆ**:
```
ç´¢å¼• 0-2:   å·¦è‡‚æœ«ç«¯ä½ç½® (left_x, left_y, left_z)
ç´¢å¼• 3:     å·¦è‡‚å¤¹çˆªçŠ¶æ€ (left_gripper) - 0æˆ–1, è¡¨ç¤ºå¼€åˆ
ç´¢å¼• 4-6:   å³è‡‚æœ«ç«¯ä½ç½® (right_x, right_y, right_z)  
ç´¢å¼• 7:     å³è‡‚å¤¹çˆªçŠ¶æ€ (right_gripper) - 0æˆ–1, è¡¨ç¤ºå¼€åˆ
```

**å…·ä½“ç¤ºä¾‹**:
```python
action[0] = [
    -0.298, -0.314, 0.942,  # å·¦è‡‚ xyz
    1.0,                     # å·¦å¤¹çˆª (1=é—­åˆ)
    0.306, -0.313, 0.941,   # å³è‡‚ xyz
    1.0                      # å³å¤¹çˆª (1=é—­åˆ)
]
```

---

## ğŸ“Š End-Pose å¤„ç†æ ¼å¼

### åŸå§‹æ•°æ® (HDF5)
```python
# æ–‡ä»¶: episode0.hdf5
'endpose/left_endpose':   [T, 7]  # [x, y, z, qw, qx, qy, qz]
'endpose/left_gripper':   [T]     # scalar, 0æˆ–1
'endpose/right_endpose':  [T, 7]  # [x, y, z, qw, qx, qy, qz]
'endpose/right_gripper':  [T]     # scalar, 0æˆ–1
```

### æå–è§„åˆ™

#### 1. ä½ç½® (Position)
```python
# ç›´æ¥å–å‰3ç»´
left_xyz = left_endpose[:3]   # [x, y, z]
right_xyz = right_endpose[:3] # [x, y, z]
```

#### 2. å››å…ƒæ•° (Quaternion) - **ä¸ä½¿ç”¨**
```python
# åŸå§‹æ•°æ®æœ‰å››å…ƒæ•° [qw, qx, qy, qz]ï¼Œä½†æˆ‘ä»¬ä¸é¢„æµ‹æ—‹è½¬
# åªé¢„æµ‹ä½ç½® xyz + å¤¹çˆªçŠ¶æ€
```

#### 3. å¤¹çˆªçŠ¶æ€ (Gripper)
```python
# ç›´æ¥ä½¿ç”¨
left_gripper_state = endpose['left_gripper'][t]   # 0 æˆ– 1
right_gripper_state = endpose['right_gripper'][t] # 0 æˆ– 1
```

---

## ğŸ”„ æ•°æ®è½¬æ¢æµç¨‹

### ä» HDF5 åˆ°è®­ç»ƒæ ¼å¼

```python
# è¯»å–ä¸€å¸§çš„æ•°æ®
t = 10  # æŸä¸ªæ—¶é—´æ­¥

# 1. è¯»å–åŸå§‹æ•°æ®
left_pose_7d = f['endpose/left_endpose'][t]    # [x,y,z,qw,qx,qy,qz]
right_pose_7d = f['endpose/right_endpose'][t]  # [x,y,z,qw,qx,qy,qz]
left_gripper = f['endpose/left_gripper'][t]    # scalar
right_gripper = f['endpose/right_gripper'][t]  # scalar

# 2. æå–éœ€è¦çš„éƒ¨åˆ†
left_xyz = left_pose_7d[:3]    # [3]
right_xyz = right_pose_7d[:3]  # [3]

# 3. ç»„åˆæˆ8ç»´å‘é‡
action_8d = np.concatenate([
    left_xyz,        # [3] - å·¦è‡‚ä½ç½®
    [left_gripper],  # [1] - å·¦å¤¹çˆª
    right_xyz,       # [3] - å³è‡‚ä½ç½®
    [right_gripper]  # [1] - å³å¤¹çˆª
])  # shape: [8]
```

---

## ğŸ“ å®Œæ•´æ•°æ®ç»´åº¦

### è®­ç»ƒæ ·æœ¬
```python
sample = {
    'obs': {
        'point_cloud': np.array([
            [[x, y, z], ...],  # å¸§0, 1024ä¸ªç‚¹
            [[x, y, z], ...],  # å¸§1, 1024ä¸ªç‚¹
            [[x, y, z], ...],  # å¸§2, 1024ä¸ªç‚¹
        ]),  # shape: [3, 1024, 3]
    },
    'action': np.array([
        [lx, ly, lz, lg, rx, ry, rz, rg],  # æœªæ¥å¸§0
        [lx, ly, lz, lg, rx, ry, rz, rg],  # æœªæ¥å¸§1
        [lx, ly, lz, lg, rx, ry, rz, rg],  # æœªæ¥å¸§2
        [lx, ly, lz, lg, rx, ry, rz, rg],  # æœªæ¥å¸§3
        [lx, ly, lz, lg, rx, ry, rz, rg],  # æœªæ¥å¸§4
        [lx, ly, lz, lg, rx, ry, rz, rg],  # æœªæ¥å¸§5
    ])  # shape: [6, 8]
}
```

### æ‰¹æ¬¡æ•°æ® (DataLoader)
```python
batch = {
    'obs': {
        'point_cloud': torch.Size([B, 3, 1024, 3])
    },
    'action': torch.Size([B, 6, 8])
}
```
å…¶ä¸­ B = batch_size (ä¾‹å¦‚ 256)

---

## âš™ï¸ DP3 é…ç½®è°ƒæ•´

### åŸå§‹é…ç½®
```yaml
horizon: 8           # é¢„æµ‹8å¸§
n_obs_steps: 3       # è§‚æµ‹3å¸§
n_action_steps: 6    # æ‰§è¡Œ6å¸§
```

### æ–°é…ç½® (ä¿æŒä¸å˜)
```yaml
horizon: 8           # é¢„æµ‹8å¸§ (ä½†æˆ‘ä»¬åªç”¨å‰6å¸§)
n_obs_steps: 3       # è§‚æµ‹3å¸§ âœ“
n_action_steps: 6    # æ‰§è¡Œ6å¸§ âœ“

shape_meta:
  obs:
    point_cloud:
      shape: [1024, 3]   # æ¯å¸§1024ä¸ªç‚¹ï¼Œ3Dåæ ‡
      type: point_cloud
  action:
    shape: [8]           # 8ç»´åŠ¨ä½œå‘é‡
    type: low_dim
```

---

## ğŸ¬ å®é™…ä½¿ç”¨æµç¨‹

### è®­ç»ƒé˜¶æ®µ
```python
# è¾“å…¥: å†å²3å¸§ç‚¹äº‘
obs = get_point_clouds(frames=[t-2, t-1, t])  # [3, 1024, 3]

# æ ‡ç­¾: æœªæ¥6å¸§çš„æœ«ç«¯ä½å§¿+å¤¹çˆª
action = get_actions(frames=[t, t+1, t+2, t+3, t+4, t+5])  # [6, 8]

# è®­ç»ƒ
loss = model.compute_loss(obs, action)
```

### æ¨ç†é˜¶æ®µ
```python
# 1. è·å–å½“å‰è§‚æµ‹
current_obs = {
    'point_cloud': robot.get_point_clouds(n=3)  # [3, 1024, 3]
}

# 2. æ¨¡å‹é¢„æµ‹
predicted_actions = model.predict(current_obs)  # [6, 8]

# 3. æ‰§è¡ŒåŠ¨ä½œ
for i in range(6):
    action = predicted_actions[i]  # [8]
    
    # åˆ†è§£åŠ¨ä½œ
    left_xyz = action[0:3]
    left_gripper = action[3]
    right_xyz = action[4:7]
    right_gripper = action[7]
    
    # å‘é€ç»™æœºå™¨äºº
    robot.move_left_arm(target_pos=left_xyz, gripper=left_gripper)
    robot.move_right_arm(target_pos=right_xyz, gripper=right_gripper)
    
    time.sleep(0.1)  # 10Hzæ§åˆ¶é¢‘ç‡

# 4. é‡å¤ï¼ˆè·å–æ–°çš„3å¸§è§‚æµ‹ï¼‰
```

---

## ğŸ” å…³é”®ç¡®è®¤ç‚¹

### âœ… è¯·ç¡®è®¤ä»¥ä¸‹å†…å®¹æ˜¯å¦æ­£ç¡®ï¼š

1. **åªé¢„æµ‹ä½ç½®ï¼Œä¸é¢„æµ‹æ—‹è½¬**
   - âœ“ æ˜¯çš„ï¼Œåªç”¨ xyz åæ ‡
   - âœ— å¦‚æœéœ€è¦æ—‹è½¬ï¼Œéœ€è¦å¢åŠ ç»´åº¦

2. **å¤¹çˆªçŠ¶æ€æ˜¯äºŒå€¼çš„**
   - âœ“ 0 æˆ– 1 (å¼€åˆçŠ¶æ€)
   - âœ— å¦‚æœæ˜¯è¿ç»­å€¼ï¼Œéœ€è¦è°ƒæ•´å½’ä¸€åŒ–

3. **ç‚¹äº‘åªç”¨xyzåæ ‡**
   - âœ“ åªç”¨å‰3ä¸ªé€šé“
   - âœ— å¦‚æœéœ€è¦é¢œè‰²ï¼Œæ”¹ä¸º shape: [1024, 6]

4. **é¢„æµ‹æœªæ¥6å¸§**
   - âœ“ horizon=8, ä½†å®é™…ä½¿ç”¨å‰6å¸§
   - âœ— å¦‚æœéœ€è¦æ›´å¤š/æ›´å°‘ï¼Œè°ƒæ•´ n_action_steps

5. **TCPåæ ‡é—®é¢˜**
   - â“ æ˜¯å¦éœ€è¦åƒ save_episode0_pc_gripper_png.py é‚£æ ·åŠ  0.12m åç§»ï¼Ÿ
   - ç›®å‰ä»£ç **ç›´æ¥ä½¿ç”¨** endpose ä¸­çš„åæ ‡
   - å¦‚éœ€åç§»ï¼Œå¯ä»¥åœ¨æ•°æ®å¤„ç†æ—¶æ·»åŠ 

---

## ğŸ“ æ•°æ®ç¤ºä¾‹

### ä¸€ä¸ªå®Œæ•´çš„è®­ç»ƒæ ·æœ¬
```python
{
    'obs': {
        'point_cloud': array([  # shape: [3, 1024, 3]
            # å¸§ t-2
            [[-0.5, 0.2, 0.8], [-0.4, 0.3, 0.9], ...],  # 1024ä¸ªç‚¹
            # å¸§ t-1  
            [[-0.5, 0.2, 0.8], [-0.4, 0.3, 0.9], ...],  # 1024ä¸ªç‚¹
            # å¸§ t
            [[-0.5, 0.2, 0.8], [-0.4, 0.3, 0.9], ...],  # 1024ä¸ªç‚¹
        ])
    },
    'action': array([  # shape: [6, 8]
        [-0.298, -0.314, 0.942, 1.0, 0.306, -0.313, 0.941, 1.0],  # å¸§ t
        [-0.297, -0.313, 0.941, 1.0, 0.305, -0.312, 0.940, 1.0],  # å¸§ t+1
        [-0.296, -0.312, 0.940, 1.0, 0.304, -0.311, 0.939, 1.0],  # å¸§ t+2
        [-0.295, -0.311, 0.939, 1.0, 0.303, -0.310, 0.938, 1.0],  # å¸§ t+3
        [-0.294, -0.310, 0.938, 0.0, 0.302, -0.309, 0.937, 0.0],  # å¸§ t+4 (å¤¹çˆªæ‰“å¼€)
        [-0.293, -0.309, 0.937, 0.0, 0.301, -0.308, 0.936, 0.0],  # å¸§ t+5
    ])
}
```

---

## ğŸš€ ä¸‹ä¸€æ­¥

è¯·ç¡®è®¤ï¼š
1. **è¾“å‡ºæ ¼å¼**æ˜¯å¦æ­£ç¡®ï¼Ÿ(8ç»´: å·¦xyz+å·¦çˆª+å³xyz+å³çˆª)
2. **æ˜¯å¦éœ€è¦TCPåç§»**ï¼Ÿ(+0.12m æ²¿xè½´)
3. **æ˜¯å¦éœ€è¦æ—‹è½¬ä¿¡æ¯**ï¼Ÿ(å½“å‰åªé¢„æµ‹ä½ç½®)
4. **å¤¹çˆªçŠ¶æ€æ˜¯äºŒå€¼è¿˜æ˜¯è¿ç»­**ï¼Ÿ(å½“å‰å‡è®¾0/1)

ç¡®è®¤åæˆ‘ä¼šç«‹å³ç”Ÿæˆå®Œæ•´çš„ï¼š
- âœ… æ•°æ®å¤„ç†è„šæœ¬ (HDF5 â†’ Zarr)
- âœ… è®­ç»ƒé…ç½®æ–‡ä»¶ (YAML)
- âœ… è®­ç»ƒè„šæœ¬ (Shell + Python)
- âœ… æ¨ç†è„šæœ¬ (é¢„æµ‹å¹¶å¯è§†åŒ–)

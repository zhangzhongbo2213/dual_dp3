# DP3-GNN-EndPose 架构详解

## 设计理念

将**图神经网络(GNN)**与**Diffusion Policy**结合，显式建模机器人运动学和双臂协同关系。

## 核心创新点

### 1. 多层图结构

#### Level 1: 单臂内部图 (Intra-Arm Graph)
```
关节链式连接 (7个节点: 6关节 + 1gripper):
Joint0 ←→ Joint1 ←→ Joint2 ←→ ... ←→ Joint5 ←→ Gripper

功能: 传播关节间的运动学约束
实现: GCN (Graph Convolutional Network)
```

#### Level 2: 关节-EndPose图 (Joint-EndPose Graph)
```
末端关节连接到未来所有EndPose:
                ┌→ Future_t+1
                ├→ Future_t+2
Joint5(末端) →──┼→ Future_t+3
                ├→ Future_t+4
                ├→ Future_t+5
                └→ Future_t+6

功能: 将未来目标反馈到当前关节状态
实现: GAT (Graph Attention Network)
```

#### Level 3: 双臂交互图 (Bi-Arm Interaction)
```
左臂聚合特征 ←─MLP─→ 右臂聚合特征

功能: 建模双臂协同关系
实现: Cross-arm MLP + Feature Fusion
```

### 2. 信息流

```
┌─────────────────┐
│  3帧点云观测    │
│  [B, 3, 1024, 3]│
└────────┬────────┘
         │
         ▼
    ┌────────┐
    │PointNet│
    └────┬───┘
         │
         ├─────────────────────────┐
         │                         │
         │  ┌──────────────────┐   │
         │  │  当前qpos        │   │
         │  │  [B, 14]         │   │
         │  │  (7+7维)         │   │
         │  └────────┬─────────┘   │
         │           │             │
         │           ▼             │
         │  ┌──────────────────┐   │
         │  │  Robot GNN       │   │
         │  │  ┌────────────┐  │   │
         │  │  │左臂内部图  │  │   │
         │  │  │(7个节点)   │  │   │
         │  │  │右臂内部图  │  │   │
         │  │  │(7个节点)   │  │   │
         │  │  │关节-EP图   │◄─┼───┼── 未来EndPose
         │  │  │双臂交互    │  │   │   [B, 6, 4] × 2
         │  │  └────────────┘  │   │
         │  └────────┬─────────┘   │
         │           │             │
         │           ▼             │
         │  ┌──────────────────┐   │
         │  │  图特征          │   │
         │  │  [B, 1792]       │   │
         │  └────────┬─────────┘   │
         │           │             │
         ▼           ▼             │
    ┌──────────────────────────┐   │
    │  点云特征 + 图特征        │◄──┘
    │  [B, 2176]               │
    └─────────┬────────────────┘
              │
              ▼
    ┌──────────────────────┐
    │  Conditional UNet1D  │
    │  (Diffusion Model)   │
    └─────────┬────────────┘
              │
              ▼
    ┌──────────────────────┐
    │  预测动作序列        │
    │  [B, 8, 14]          │
    │  (取前6步执行)       │
    └──────────────────────┘
```

## 数学形式

### 1. 图神经网络

#### 单臂内部图更新
```
H^(l+1)_i = LayerNorm(GCN(H^(l)_i, A_arm))
```
其中:
- `H^(l)_i`: 第l层第i个关节的特征
- `A_arm`: 关节邻接矩阵 (链式连接)

#### 关节-EndPose图更新
```
H_joint = GAT([H_joint; H_endpose], A_joint_ep)
```
其中:
- `H_joint`: 关节特征 [num_joints, d]
- `H_endpose`: EndPose特征 [6, d]
- `A_joint_ep`: 关节到EndPose的边

#### 双臂交互
```
L_enhanced = Fusion([L_agg; MLP_R2L(R_agg)])
R_enhanced = Fusion([R_agg; MLP_L2R(L_agg)])
```
其中:
- `L_agg, R_agg`: 左右臂聚合特征
- `MLP_R2L, MLP_L2R`: 跨臂信息传递MLP

### 2. Diffusion Policy

#### 训练
```
L = E[||ε - ε_θ(z_t, t, c_global)||^2]
```
其中:
- `z_t`: 加噪的动作序列
- `c_global`: [点云特征; 图特征]
- `ε_θ`: 去噪网络
- `ε`: 真实噪声

#### 推理 (DDIM)
```
z_{t-1} = α_{t-1} * (z_t - √(1-α_t) * ε_θ(z_t, t, c_global)) / α_t 
          + √(1-α_{t-1}) * ε_θ(z_t, t, c_global)
```

## 与其他方法对比

| 方法 | 输入 | 结构建模 | 双臂协同 | 未来指导 |
|-----|------|----------|----------|----------|
| **DP3** | 点云 + state | ❌ | 隐式 | ❌ |
| **DP3-EndPose** | 点云 | ❌ | 隐式 | ❌ |
| **DP3-GNN-EndPose** | 点云 + qpos + EndPose | ✅ GNN | ✅ 显式图 | ✅ 6帧 |

## 关键优势

1. **结构化表示**: GNN显式编码运动学约束
2. **目标引导**: 未来EndPose指导当前动作生成
3. **双臂协同**: 显式建模左右臂交互
4. **端到端训练**: 所有组件联合优化

## 参数量分析

```
组件                     参数量 (估算)
─────────────────────────────────────
PointNet编码器            ~1.2M
GNN模块:
  - 单臂图 × 2            ~0.3M
  - 关节-EP图 × 2         ~0.2M
  - 双臂交互              ~0.4M
Diffusion UNet1D          ~30M
─────────────────────────────────────
总计                      ~32M
```

相比原始DP3增加约1M参数 (~3%增长)

## 计算复杂度

| 操作 | 复杂度 | 说明 |
|-----|--------|------|
| PointNet | O(N) | N=点云点数 |
| 单臂GCN | O(E*d) | E=边数(~10), d=特征维度 |
| 关节-EP GAT | O(K*6*d) | K=注意力头数 |
| 双臂MLP | O(d^2) | d=臂特征维度 |
| Diffusion UNet | O(T*d^2) | T=horizon |

**总体**: 相比原始DP3增加约10-15%计算量

## 实现细节

### 图结构定义

```python
# 单臂内部边 (链式，包括gripper)
arm_edges = [[0,1], [1,2], [2,3], [3,4], [4,5], [5,6],
             [1,0], [2,1], [3,2], [4,3], [5,4], [6,5]]  # 双向

# 关节-EndPose边 (最后一个节点gripper连接到所有未来)
joint_ep_edges = [[6, 7], [6, 8], [6, 9], [6, 10], [6, 11], [6, 12],
                  [7, 6], [8, 6], [9, 6], [10, 6], [11, 6], [12, 6]]
# 其中7-12是6个未来EndPose节点的索引
```

### 特征维度

```python
# 输入
qpos_per_joint: 1          # 每个关节的qpos维度
endpose_dim: 4             # xyz + gripper
num_joints: 7              # 每臂关节数 (6关节 + 1gripper)
num_future: 6              # 未来帧数

# 隐藏
gnn_hidden_dim: 128        # GNN隐藏层

# 输出
arm_feature_dim: 7*128=896  # 单臂特征
gnn_output_dim: 896*2=1792  # 双臂特征
```

## 训练技巧

1. **Warmup**: 前500步线性warmup学习率
2. **EMA**: 使用指数移动平均稳定训练
3. **Gradient Clipping**: 梯度裁剪防止爆炸
4. **数据增强**: 点云随机旋转/平移
5. **Curriculum Learning**: 逐步增加horizon长度

## 未来改进方向

1. **动态图结构**: 根据任务自适应调整图连接
2. **时序图**: 在时间维度上也构建图结构
3. **注意力可视化**: 分析哪些关节对任务最重要
4. **多模态融合**: 加入RGB图像等其他模态
5. **在线EndPose**: 实时更新EndPose预测而非预先计算

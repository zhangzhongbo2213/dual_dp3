# DP3 æ•°æ®å¤„ç†ä¸è®­ç»ƒæµç¨‹åˆ†æ

åŸºäºå‘½ä»¤ï¼š
```bash
bash process_data.sh beat_block_hammer demo_clean 50
bash train.sh beat_block_hammer demo_clean 50 0 0
```

## ğŸ“Š å®Œæ•´æ•°æ®æµå›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          1. åŸå§‹æ•°æ®æ”¶é›†é˜¶æ®µ                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
        /mnt/4T/RoboTwin/data/beat_block_hammer/demo_clean/
                                    â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚         data/                  â”‚
                    â”‚    â”œâ”€â”€ episode0.hdf5          â”‚
                    â”‚    â”œâ”€â”€ episode1.hdf5          â”‚
                    â”‚    â”œâ”€â”€ ...                    â”‚
                    â”‚    â””â”€â”€ episode49.hdf5 (50ä¸ª)  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                    æ¯ä¸ªHDF5æ–‡ä»¶åŒ…å«:
                    â”œâ”€â”€ /joint_action/left_gripper  [T, dim]
                    â”œâ”€â”€ /joint_action/left_arm      [T, 7]
                    â”œâ”€â”€ /joint_action/right_gripper [T, dim]
                    â”œâ”€â”€ /joint_action/right_arm     [T, 7]
                    â”œâ”€â”€ /joint_action/vector        [T, state_dim] (æœºå™¨äººçŠ¶æ€)
                    â””â”€â”€ /pointcloud                 [T, N, 3] (ç‚¹äº‘æ•°æ®)
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       2. æ•°æ®é¢„å¤„ç†é˜¶æ®µ (process_data.sh)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                    å‘½ä»¤: bash process_data.sh beat_block_hammer demo_clean 50
                    æ‰§è¡Œ: python scripts/process_data.py $task_name $task_config $expert_data_num
                                    â”‚
                                    â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚    scripts/process_data.py ä¸»è¦å¤„ç†æµç¨‹:                â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚  for episode in range(50):                             â”‚
        â”‚    1. åŠ è½½ episode{i}.hdf5                             â”‚
        â”‚       - left/right_gripper, left/right_arm             â”‚
        â”‚       - vector (joint state)                           â”‚
        â”‚       - pointcloud                                     â”‚
        â”‚                                                         â”‚
        â”‚    2. æå–æ¯ä¸ªæ—¶é—´æ­¥çš„æ•°æ®:                             â”‚
        â”‚       for j in range(T-1):  # Tæ˜¯è½¨è¿¹é•¿åº¦              â”‚
        â”‚         - observation (tæ—¶åˆ»):                         â”‚
        â”‚           * pointcloud[j]      [N, 3]                  â”‚
        â”‚           * joint_state[j]     [state_dim]             â”‚
        â”‚         - action (t+1æ—¶åˆ»çš„çŠ¶æ€ä½œä¸ºaction):             â”‚
        â”‚           * joint_state[j+1]   [state_dim]             â”‚
        â”‚                                                         â”‚
        â”‚    3. ç´¯ç§¯æ‰€æœ‰æ•°æ®åˆ°æ•°ç»„                                â”‚
        â”‚       - point_cloud_arrays    [æ€»å¸§æ•°, N, 3]           â”‚
        â”‚       - state_arrays          [æ€»å¸§æ•°, state_dim]      â”‚
        â”‚       - joint_action_arrays   [æ€»å¸§æ•°, state_dim]      â”‚
        â”‚       - episode_ends_arrays   [50] (æ¯æ®µç»“æŸä½ç½®)       â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   ä¿å­˜ä¸º Zarr æ ¼å¼ (é«˜æ•ˆå‹ç¼©å­˜å‚¨):                      â”‚
        â”‚   ./data/beat_block_hammer-demo_clean-50.zarr/         â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚   â”œâ”€â”€ data/                                            â”‚
        â”‚   â”‚   â”œâ”€â”€ point_cloud   [æ€»å¸§æ•°, N, 3]  float32       â”‚
        â”‚   â”‚   â”œâ”€â”€ state         [æ€»å¸§æ•°, S]     float32       â”‚
        â”‚   â”‚   â””â”€â”€ action        [æ€»å¸§æ•°, A]     float32       â”‚
        â”‚   â””â”€â”€ meta/                                            â”‚
        â”‚       â””â”€â”€ episode_ends  [50]            int64          â”‚
        â”‚                                                         â”‚
        â”‚   å‹ç¼©: Blosc (zstd, level=3, shuffle=1)               â”‚
        â”‚   åˆ†å—å¤§å°: 100 samples per chunk                       â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         3. è®­ç»ƒå‡†å¤‡é˜¶æ®µ (train.sh)                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
        å‘½ä»¤: bash train.sh beat_block_hammer demo_clean 50 0 0
        å‚æ•°: task_name=beat_block_hammer, task_config=demo_clean,
              expert_data_num=50, seed=0, gpu_id=0
                                    â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   æ£€æŸ¥ zarr æ•°æ®æ˜¯å¦å­˜åœ¨       â”‚
                    â”‚   å¦‚æœä¸å­˜åœ¨ï¼Œè°ƒç”¨ process_data.sh â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
        æ‰§è¡Œ: bash scripts/train_policy.sh robot_dp3 beat_block_hammer \
                   demo_clean 50 train 0 0
                                    â”‚
                                    â–¼
        è¿›å…¥: 3D-Diffusion-Policy/
        æ‰§è¡Œ: python train_dp3.py --config-name=robot_dp3.yaml \
                   task_name=beat_block_hammer \
                   expert_data_num=50 \
                   setting=demo_clean \
                   training.seed=0 \
                   training.device="cuda:0"
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         4. æ•°æ®åŠ è½½é˜¶æ®µ (Dataset)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   RobotDataset åˆå§‹åŒ–:                                 â”‚
        â”‚   (diffusion_policy_3d/dataset/robot_dataset.py)       â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚   1. åŠ è½½ Zarr æ•°æ®:                                   â”‚
        â”‚      replay_buffer = ReplayBuffer.copy_from_path(      â”‚
        â”‚          "../../data/beat_block_hammer-demo_clean-50.zarr", â”‚
        â”‚          keys=["state", "action", "point_cloud"]       â”‚
        â”‚      )                                                  â”‚
        â”‚                                                         â”‚
        â”‚   2. åˆ’åˆ†è®­ç»ƒ/éªŒè¯é›†:                                   â”‚
        â”‚      - val_ratio = 0.0 (é»˜è®¤å…¨éƒ¨ç”¨äºè®­ç»ƒ)              â”‚
        â”‚      - train_mask / val_mask                           â”‚
        â”‚                                                         â”‚
        â”‚   3. åˆ›å»ºåºåˆ—é‡‡æ ·å™¨:                                    â”‚
        â”‚      SequenceSampler(                                  â”‚
        â”‚          replay_buffer=replay_buffer,                  â”‚
        â”‚          sequence_length=horizon (8),                  â”‚
        â”‚          pad_before=n_obs_steps (3),                   â”‚
        â”‚          pad_after=n_action_steps (6)                  â”‚
        â”‚      )                                                  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   æ•°æ®å½’ä¸€åŒ– (get_normalizer):                         â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚   LinearNormalizer è®¡ç®—ç»Ÿè®¡é‡:                         â”‚
        â”‚   - action:      [æ€»å¸§æ•°, action_dim]                  â”‚
        â”‚   - agent_pos:   [æ€»å¸§æ•°, state_dim]                   â”‚
        â”‚   - point_cloud: [æ€»å¸§æ•°, N, 3]                        â”‚
        â”‚                                                         â”‚
        â”‚   å½’ä¸€åŒ–æ–¹å¼: mode="limits"                             â”‚
        â”‚   - è®¡ç®— min/max æˆ– mean/std                           â”‚
        â”‚   - ä¿å­˜å½’ä¸€åŒ–å‚æ•°ä¾›è®­ç»ƒå’Œæ¨ç†ä½¿ç”¨                      â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    5. è®­ç»ƒå¾ªç¯ (Training Loop)                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   DataLoader æ‰¹æ¬¡é‡‡æ ·:                                 â”‚
        â”‚   (batch_size=256, num_workers=8)                      â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚   æ¯ä¸ª batch åŒ…å«:                                      â”‚
        â”‚   {                                                     â”‚
        â”‚     "obs": {                                            â”‚
        â”‚       "point_cloud": [B, T_obs=3, N, 3],               â”‚
        â”‚       "agent_pos":   [B, T_obs=3, state_dim]           â”‚
        â”‚     },                                                  â”‚
        â”‚     "action": [B, T_action=8, action_dim]              â”‚
        â”‚   }                                                     â”‚
        â”‚                                                         â”‚
        â”‚   å…¶ä¸­:                                                 â”‚
        â”‚   - B: batch size (256)                                â”‚
        â”‚   - T_obs: è§‚æµ‹åºåˆ—é•¿åº¦ (n_obs_steps=3)                â”‚
        â”‚   - T_action: åŠ¨ä½œåºåˆ—é•¿åº¦ (horizon=8)                 â”‚
        â”‚   - N: ç‚¹äº‘ç‚¹æ•°                                         â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   DP3 æ¨¡å‹å‰å‘ä¼ æ’­:                                     â”‚
        â”‚   (diffusion_policy_3d/policy/dp3.py)                  â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚   1. ç‚¹äº‘ç¼–ç :                                          â”‚
        â”‚      pointcloud_encoder(point_cloud)                   â”‚
        â”‚      â†’ [B, T_obs, encoder_output_dim=128]              â”‚
        â”‚                                                         â”‚
        â”‚   2. çŠ¶æ€åµŒå…¥:                                          â”‚
        â”‚      - æ‹¼æ¥ç‚¹äº‘ç‰¹å¾å’Œ agent_pos                         â”‚
        â”‚      - ä½œä¸ºæ¡ä»¶è¾“å…¥                                     â”‚
        â”‚                                                         â”‚
        â”‚   3. Diffusion è¿‡ç¨‹:                                    â”‚
        â”‚      a. åŠ å™ª: å‘ action æ·»åŠ é«˜æ–¯å™ªå£°                    â”‚
        â”‚         x_t = âˆš(á¾±_t) * x_0 + âˆš(1-á¾±_t) * Îµ              â”‚
        â”‚                                                         â”‚
        â”‚      b. UNet å»å™ªé¢„æµ‹:                                  â”‚
        â”‚         - è¾“å…¥: noisy_action, timestep, condition       â”‚
        â”‚         - æ¡ä»¶èåˆ: FiLM (Feature-wise Linear Modulation)â”‚
        â”‚           * use_down_condition: ä¸‹é‡‡æ ·å±‚æ¡ä»¶             â”‚
        â”‚           * use_mid_condition:  ä¸­é—´å±‚æ¡ä»¶               â”‚
        â”‚           * use_up_condition:   ä¸Šé‡‡æ ·å±‚æ¡ä»¶             â”‚
        â”‚         - è¾“å‡º: é¢„æµ‹çš„å™ªå£° æˆ– å»å™ªåçš„action             â”‚
        â”‚                                                         â”‚
        â”‚   4. æŸå¤±è®¡ç®—:                                          â”‚
        â”‚      loss = MSE(predicted, target)                     â”‚
        â”‚      - prediction_type="sample": ç›´æ¥é¢„æµ‹ x_0           â”‚
        â”‚      - æ¢¯åº¦ç´¯ç§¯: loss / gradient_accumulate_every       â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   ä¼˜åŒ–æ›´æ–°:                                             â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚   1. Backward: loss.backward()                         â”‚
        â”‚   2. Optimizer step: AdamW                             â”‚
        â”‚      - lr: 1.0e-4                                      â”‚
        â”‚      - weight_decay: 1.0e-6                            â”‚
        â”‚   3. LR scheduler: cosine with warmup                  â”‚
        â”‚      - warmup_steps: 500                               â”‚
        â”‚   4. EMA æ›´æ–°:                                          â”‚
        â”‚      - æŒ‡æ•°ç§»åŠ¨å¹³å‡ä¿æŒæ›´ç¨³å®šçš„æ¨¡å‹                     â”‚
        â”‚      - update_after_step: 0                            â”‚
        â”‚      - decay: 0.9999 (max_value)                       â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   Checkpoint ä¿å­˜:                                     â”‚
        â”‚   (æ¯ checkpoint_every=3000 epochs)                    â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚   ä¿å­˜è·¯å¾„:                                             â”‚
        â”‚   checkpoints/beat_block_hammer-demo_clean-50_0/       â”‚
        â”‚       â””â”€â”€ {epoch}.ckpt                                 â”‚
        â”‚                                                         â”‚
        â”‚   åŒ…å«:                                                 â”‚
        â”‚   - model.state_dict()                                 â”‚
        â”‚   - ema_model.state_dict()                             â”‚
        â”‚   - optimizer.state_dict()                             â”‚
        â”‚   - global_step, epoch                                 â”‚
        â”‚   - cfg (å®Œæ•´é…ç½®)                                      â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           6. æ¨ç†é˜¶æ®µ (å¯é€‰)                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   DDIM é‡‡æ ·è¿‡ç¨‹:                                        â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚   1. åˆå§‹åŒ–: x_T ~ N(0, I)                             â”‚
        â”‚      éšæœºé«˜æ–¯å™ªå£° [B, T_action, action_dim]             â”‚
        â”‚                                                         â”‚
        â”‚   2. è¿­ä»£å»å™ª (num_inference_steps=10):                â”‚
        â”‚      for t in reversed([0, ..., T-1]):                 â”‚
        â”‚        - æ¡ä»¶è¾“å…¥: å½“å‰è§‚æµ‹ (ç‚¹äº‘ + çŠ¶æ€)               â”‚
        â”‚        - UNet é¢„æµ‹: x_t â†’ x_{t-1}                      â”‚
        â”‚        - DDIM æ›´æ–°å…¬å¼                                  â”‚
        â”‚                                                         â”‚
        â”‚   3. åå½’ä¸€åŒ–:                                          â”‚
        â”‚      action = normalizer.unnormalize(x_0)              â”‚
        â”‚                                                         â”‚
        â”‚   4. æ‰§è¡ŒåŠ¨ä½œ:                                          â”‚
        â”‚      - å–å‰ n_action_steps æ­¥æ‰§è¡Œ                       â”‚
        â”‚      - æ»‘åŠ¨çª—å£æ›´æ–°è§‚æµ‹                                 â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

## ğŸ“‹ å…³é”®è¶…å‚æ•°é…ç½®

### æ•°æ®å¤„ç†
- **ä»»åŠ¡åç§°**: beat_block_hammer
- **é…ç½®**: demo_clean
- **è®­ç»ƒæ ·æœ¬æ•°**: 50 episodes
- **æ•°æ®æ ¼å¼**: HDF5 â†’ Zarr (å‹ç¼©)

### æ¨¡å‹æ¶æ„
- **ç­–ç•¥ç±»å‹**: DP3 (3D Diffusion Policy)
- **ç‚¹äº‘ç¼–ç å™¨**: PointNet (encoder_output_dim=128)
- **æ¡ä»¶èåˆ**: FiLM (Feature-wise Linear Modulation)
  - use_down_condition: true
  - use_mid_condition: true
  - use_up_condition: true

### åºåˆ—é…ç½®
- **horizon**: 8 (é¢„æµ‹åŠ¨ä½œåºåˆ—é•¿åº¦)
- **n_obs_steps**: 3 (è§‚æµ‹å†å²é•¿åº¦)
- **n_action_steps**: 6 (æ¯æ¬¡æ‰§è¡ŒåŠ¨ä½œæ•°)

### Diffusion é…ç½®
- **Scheduler**: DDIM
- **è®­ç»ƒæ­¥æ•°**: 100 timesteps
- **æ¨ç†æ­¥æ•°**: 10 steps
- **beta_schedule**: squaredcos_cap_v2
- **prediction_type**: sample (ç›´æ¥é¢„æµ‹ x_0)

### è®­ç»ƒé…ç½®
- **Batch size**: 256
- **Optimizer**: AdamW (lr=1e-4)
- **Epochs**: 3000
- **EMA**: å¯ç”¨ (decay=0.9999)
- **Device**: CUDA:0 (gpu_id=0)
- **Seed**: 0

## ğŸ”„ æ•°æ®ç»´åº¦å˜æ¢æµç¨‹

```
åŸå§‹ HDF5 æ•°æ®:
  episode{i}.hdf5 [i=0...49]
  â””â”€â”€ æ¯ä¸ª episode åŒ…å« T ä¸ªæ—¶é—´æ­¥

â†“ process_data.py å¤„ç†

Zarr æ•°æ®åº“:
  point_cloud: [æ€»å¸§æ•°(â‰ˆ50*T), N_points, 3]
  state:       [æ€»å¸§æ•°, state_dim]
  action:      [æ€»å¸§æ•°, action_dim]
  episode_ends: [50]

â†“ RobotDataset.__getitem__(idx)

è®­ç»ƒæ ·æœ¬:
  obs:
    point_cloud: [horizon=8, N_points, 3]
    agent_pos:   [horizon=8, state_dim]
  action:        [horizon=8, action_dim]

â†“ DataLoader (batch_size=256)

è®­ç»ƒæ‰¹æ¬¡:
  obs:
    point_cloud: [256, 8, N_points, 3]
    agent_pos:   [256, 8, state_dim]
  action:        [256, 8, action_dim]

â†“ DP3 æ¨¡å‹å¤„ç†

  1. ç‚¹äº‘ç¼–ç : [256, 8, N_points, 3] 
     â†’ PointNet â†’ [256, 8, 128]

  2. è§‚æµ‹æ¡ä»¶: å–å‰ n_obs_steps=3
     point_cloud: [256, 3, 128]
     agent_pos:   [256, 3, state_dim]
     
  3. Diffusion:
     è¾“å…¥: noisy_action [256, 8, action_dim]
     æ¡ä»¶: obs features [256, 3, ...]
     è¾“å‡º: predicted_action [256, 8, action_dim]
```

## ğŸ’¡ å…³é”®è®¾è®¡ç‰¹ç‚¹

### 1. åºåˆ—åŒ–å¤„ç†
- ä½¿ç”¨æ»‘åŠ¨çª—å£é‡‡æ ·: horizon=8, ä½†æ¯æ¬¡åªè§‚æµ‹å‰3æ­¥ (n_obs_steps=3)
- åŠ¨ä½œæ‰§è¡Œ: æ¯æ¬¡æ‰§è¡Œå‰6æ­¥ (n_action_steps=6), é‡å 2æ­¥æé«˜å¹³æ»‘æ€§

### 2. ç‚¹äº‘å¤„ç†
- PointNet ç¼–ç : å°†åŸå§‹ç‚¹äº‘ [N, 3] ç¼–ç ä¸ºç‰¹å¾å‘é‡ [128]
- æ”¯æŒå½©è‰²ç‚¹äº‘: use_pc_color (å¯é€‰, [N, 6])
- ç‚¹äº‘è£å‰ª: use_point_crop=true, crop_shape=[80, 80]

### 3. Diffusion ç­–ç•¥
- DDIM åŠ é€Ÿé‡‡æ ·: è®­ç»ƒ100æ­¥, æ¨ç†åªéœ€10æ­¥
- FiLM æ¡ä»¶æ³¨å…¥: åœ¨ UNet çš„å¤šä¸ªå±‚çº§æ³¨å…¥è§‚æµ‹æ¡ä»¶
- EMA ç¨³å®šè®­ç»ƒ: ä¿æŒæ¨¡å‹æƒé‡çš„æŒ‡æ•°ç§»åŠ¨å¹³å‡

### 4. æ•°æ®æ•ˆç‡
- Zarr æ ¼å¼: é«˜æ•ˆå‹ç¼©å­˜å‚¨ (Blosc/zstd)
- åˆ†å—å­˜å‚¨: chunk_size=100, åŠ é€Ÿéšæœºè®¿é—®
- å†…å­˜æ˜ å°„: æ”¯æŒå¤§è§„æ¨¡æ•°æ®é›†

## ğŸ“ æ–‡ä»¶ç»“æ„æ€»è§ˆ

```
policy/DP3/
â”œâ”€â”€ process_data.sh                    # æ•°æ®å¤„ç†å…¥å£
â”œâ”€â”€ train.sh                           # è®­ç»ƒå…¥å£
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ process_data.py                # HDF5 â†’ Zarr è½¬æ¢
â”‚   â””â”€â”€ train_policy.sh                # è®­ç»ƒè„šæœ¬å¯åŠ¨å™¨
â”œâ”€â”€ 3D-Diffusion-Policy/
â”‚   â”œâ”€â”€ train_dp3.py                   # ä¸»è®­ç»ƒå¾ªç¯
â”‚   â”œâ”€â”€ diffusion_policy_3d/
â”‚   â”‚   â”œâ”€â”€ policy/dp3.py              # DP3 ç­–ç•¥æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ dataset/robot_dataset.py   # æ•°æ®åŠ è½½å™¨
â”‚   â”‚   â”œâ”€â”€ model/
â”‚   â”‚   â”‚   â”œâ”€â”€ diffusion/            # Diffusion æ¨¡å—
â”‚   â”‚   â”‚   â””â”€â”€ vision/               # ç‚¹äº‘ç¼–ç å™¨
â”‚   â”‚   â””â”€â”€ config/
â”‚   â”‚       â””â”€â”€ robot_dp3.yaml        # é…ç½®æ–‡ä»¶
â”‚   â””â”€â”€ checkpoints/                   # ä¿å­˜çš„æ¨¡å‹æƒé‡
â””â”€â”€ data/
    â””â”€â”€ {task_name}-{config}-{num}.zarr/  # å¤„ç†åçš„è®­ç»ƒæ•°æ®
```

## ğŸš€ å¿«é€Ÿä½¿ç”¨æµç¨‹

```bash
# 1. æ•°æ®å¤„ç† (åªéœ€è¿è¡Œä¸€æ¬¡)
cd /mnt/4T/RoboTwin/policy/DP3
bash process_data.sh beat_block_hammer demo_clean 50

# 2. è®­ç»ƒæ¨¡å‹
bash train.sh beat_block_hammer demo_clean 50 0 0
#             â””â”€ä»»åŠ¡å      â””â”€é…ç½®  â””æ•°æ®é‡ â””seed â””gpu

# 3. æŸ¥çœ‹è®­ç»ƒæ—¥å¿— (WandB)
# é¡¹ç›®: RoboTwin
# å®éªŒå: beat_block_hammer-robot_dp3-train

# 4. è¯„ä¼°/éƒ¨ç½² (æ¨ç†)
bash eval.sh beat_block_hammer demo_clean 50 0 0 3000
#            â””â”€ä»»åŠ¡å      â””â”€é…ç½®  â””æ•°æ®é‡ â””seed â””gpu â””checkpoint
```

## ğŸ“Š ç›‘æ§æŒ‡æ ‡

è®­ç»ƒè¿‡ç¨‹ä¸­å¯ä»¥åœ¨ WandB ç›‘æ§:
- **train_loss**: è®­ç»ƒæŸå¤± (MSE)
- **val_loss**: éªŒè¯æŸå¤±
- **lr**: å­¦ä¹ ç‡å˜åŒ–
- **epoch**: å½“å‰è®­ç»ƒè½®æ¬¡
- **test_mean_score**: è¯„ä¼°å¾—åˆ† (å¦‚æœå¯ç”¨ rollout)

## âš™ï¸ é…ç½®æ–‡ä»¶è·¯å¾„

ä¸»è¦é…ç½®æ–‡ä»¶:
- `3D-Diffusion-Policy/diffusion_policy_3d/config/robot_dp3.yaml`
- å¯ä»¥é€šè¿‡å‘½ä»¤è¡Œå‚æ•°è¦†ç›–ä»»ä½•é…ç½®é¡¹

å¸¸ç”¨è¦†ç›–ç¤ºä¾‹:
```bash
python train_dp3.py \
    --config-name=robot_dp3.yaml \
    task_name=your_task \
    training.num_epochs=5000 \
    dataloader.batch_size=128 \
    policy.horizon=16
```

# DP3 EndPose 预测效果对比报告

> **日期**: 2025年12月19日  
> **任务**: stack_blocks_two  
> **模型**: DP3 EndPose (300 epoch checkpoint)  
> **数据**: episode2.hdf5

---

## 📊 测试结果汇总

### Case 1: 输入帧[0,1,2] → 预测帧[3-8]

**预测误差** (meters):

| 臂 | 帧3 | 帧4 | 帧5 | 帧6 | 帧7 | 帧8 | **平均误差** |
|----|-----|-----|-----|-----|-----|-----|------------|
| **左臂** | 0.00043 | 0.00061 | 0.00022 | 0.00068 | 0.00034 | 0.00069 | **0.0005m** ✅ |
| **右臂** | 0.09568 | 0.10567 | 0.11704 | 0.12781 | 0.13918 | 0.15156 | **0.1228m** ⚠️ |

**可视化**: `dp3_prediction_comparison/comparison_case1_frame2.png`

---

### Case 2: 输入帧[10,11,12] → 预测帧[13-18]

**预测误差** (meters):

| 臂 | 帧13 | 帧14 | 帧15 | 帧16 | 帧17 | 帧18 | **平均误差** |
|----|------|------|------|------|------|------|------------|
| **左臂** | 0.00019 | 0.00086 | 0.00044 | 0.00070 | 0.00102 | 0.00102 | **0.0007m** ✅ |
| **右臂** | 0.05678 | 0.06172 | 0.06764 | 0.07510 | 0.08320 | 0.09284 | **0.0729m** ⚠️ |

**可视化**: `dp3_prediction_comparison/comparison_case2_frame12.png`

---

## 🔍 详细分析

### 左臂预测表现 ✅

- **平均误差**: 0.5-0.7mm
- **最大误差**: ~1mm
- **评价**: **优秀** - 预测非常准确，误差在毫米级别

### 右臂预测表现 ⚠️

- **平均误差**: 72-122mm (7-12厘米)
- **趋势**: 误差随时间递增
- **评价**: **需要改进** - 预测存在明显偏差

---

## 📈 误差分析

### Case 1 (早期阶段)

```
左臂误差: [0.43, 0.61, 0.22, 0.68, 0.34, 0.69] mm
右臂误差: [95.68, 105.67, 117.04, 127.81, 139.18, 151.56] mm
         ↑ 误差逐步增大，说明预测轨迹发散
```

### Case 2 (中期阶段)

```
左臂误差: [0.19, 0.86, 0.44, 0.70, 1.02, 1.02] mm
右臂误差: [56.78, 61.72, 67.64, 75.10, 83.20, 92.84] mm
         ↑ 相比Case1误差更小，但仍然偏大
```

---

## 🎨 可视化说明

### 图片1: `comparison_case1_frame2.png`

**左子图 - 真实轨迹**:
- 红色系球: 左臂真实轨迹（帧3-8）
- 蓝色系球: 右臂真实轨迹（帧3-8）
- 红线/蓝线: 连接真实轨迹

**右子图 - 预测对比**:
- 绿色系三角: 左臂预测轨迹（帧3-8）
- 橙色系三角: 右臂预测轨迹（帧3-8）
- 淡色线: 真实轨迹（作为参考）
- 绿线/橙线: 连接预测轨迹

### 图片2: `comparison_case2_frame12.png`

同样的可视化方式，但显示的是：
- 输入: 帧10,11,12
- 预测: 帧13-18
- 显示在帧12的点云上

---

## 🤔 可能的原因分析

### 左臂预测准确的原因

1. ✅ 左臂在训练数据中可能运动更规律
2. ✅ 左臂的点云特征更明显
3. ✅ 训练数据中左臂的样本质量更好

### 右臂预测偏差的原因

1. ⚠️ 右臂运动模式更复杂
2. ⚠️ 点云遮挡或噪声影响
3. ⚠️ 数据不平衡（右臂样本少或质量差）
4. ⚠️ 模型对右臂的学习不充分
5. ⚠️ TCP偏移计算在右臂可能有问题

---

## 💡 改进建议

### 1. 数据层面

```bash
# 检查数据质量
python << 'EOF'
import h5py
import numpy as np

with h5py.File('/mnt/4T/RoboTwin/data/stack_blocks_two/demo_clean/data/episode2.hdf5', 'r') as f:
    left_pose = f['endpose/left_endpose'][:]
    right_pose = f['endpose/right_endpose'][:]
    
    left_motion = np.diff(left_pose[:, :3], axis=0)
    right_motion = np.diff(right_pose[:, :3], axis=0)
    
    print("Left arm motion variance:", np.var(left_motion))
    print("Right arm motion variance:", np.var(right_motion))
EOF
```

### 2. 模型层面

- 增加训练轮数（当前300 epochs，可以尝试1000-3000）
- 调整学习率
- 增加右臂的权重（loss加权）
- 使用数据增强

### 3. 验证方法

```bash
# 在更多episodes上测试
python compare_dp3_prediction_batch.py --episodes 0,1,2,3,4,5
```

### 4. 可视化改进

- 添加误差热力图
- 显示运动速度对比
- 添加时间序列误差曲线

---

## 📝 技术细节

### 模型配置

```yaml
horizon: 8          # 预测8帧（但只用前6帧）
n_obs_steps: 3      # 输入3帧点云
n_action_steps: 6   # 输出6帧动作
encoder_dim: 128    # PointNet特征维度
```

### 输入输出维度

```
输入:
  point_cloud: [1, 3, 1024, 3]  ← batch=1, 3帧观测, 1024点, xyz坐标

输出:
  action: [1, 6, 8]  ← batch=1, 6帧预测, 8维
  8维: [left_x, left_y, left_z, left_gripper, 
        right_x, right_y, right_z, right_gripper]
```

### TCP坐标转换

```python
def shift_to_tcp(pose_7d):
    """沿局部x轴+0.12m"""
    pos = pose_7d[:3]
    quat = pose_7d[3:7]  # [qw, qx, qy, qz]
    R = t3d.quaternions.quat2mat(quat)
    tcp_pos = pos + R[:, 0] * 0.12
    return tcp_pos
```

---

## 🚀 下一步行动

### 优先级1: 改进右臂预测

```bash
# 1. 增加训练时间
cd /mnt/4T/RoboTwin/policy/DP3
sed -i 's/num_epochs: 300/num_epochs: 1000/g' \
    3D-Diffusion-Policy/diffusion_policy_3d/config/robot_dp3_endpose.yaml
bash train_endpose.sh stack_blocks_two demo_clean 50 0 0

# 2. 使用更多数据
bash process_data_endpose.sh stack_blocks_two demo_clean 100
bash train_endpose.sh stack_blocks_two demo_clean 100 0 0
```

### 优先级2: 全面评估

```bash
# 在所有测试episodes上评估
for ep in {0..10}; do
    python compare_dp3_prediction.py --episode $ep
done
```

### 优先级3: 可视化改进

```bash
# 创建误差曲线
python plot_prediction_errors.py
```

---

## 📊 总结

| 指标 | 左臂 | 右臂 | 总体 |
|------|------|------|------|
| **平均误差** | 0.6mm ✅ | 97mm ⚠️ | 49mm |
| **最大误差** | 1.0mm | 152mm | 152mm |
| **准确度** | 优秀 | 需改进 | 中等 |

### 结论

1. ✅ **左臂预测非常准确** (亚毫米级)
2. ⚠️ **右臂预测存在明显偏差** (厘米级)
3. 📈 **模型已学到基本运动规律**，但需要进一步优化
4. 🔧 **建议延长训练时间或增加数据量**

---

**报告生成时间**: 2025年12月19日 22:46  
**生成脚本**: `/mnt/4T/RoboTwin/compare_dp3_prediction.py`  
**输出目录**: `/mnt/4T/RoboTwin/dp3_prediction_comparison/`

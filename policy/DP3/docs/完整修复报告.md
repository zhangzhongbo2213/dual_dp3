# DP3-EndPose å’Œ DP3-GNN-EndPose å®Œæ•´ä¿®å¤æŠ¥å‘Š

> **ä¿®å¤æ—¥æœŸ**: 2025å¹´12æœˆ22æ—¥  
> **ä¿®å¤çŠ¶æ€**: âœ… æ‰€æœ‰é—®é¢˜å·²ä¿®å¤

---

## ğŸ“‹ ä¿®å¤æ¦‚è§ˆ

### ä¿®å¤çš„é—®é¢˜

1. âœ… **DP3-EndPose æ•°æ®å¤„ç†æ—¶é—´å¯¹é½é”™è¯¯**
2. âœ… **DP3-GNN-EndPose æ•°æ®é›†æœªåŠ è½½ EndPose Future æ•°æ®**
3. âœ… **æ¸…ç†æ—§æ•°æ®å’Œè®­ç»ƒç»“æœ**

---

## ğŸ”§ è¯¦ç»†ä¿®å¤å†…å®¹

### 1. DP3-EndPose æ•°æ®å¤„ç†ä¿®å¤

**æ–‡ä»¶**: `scripts/process_data_endpose.py`

#### ä¿®å¤å‰çš„é—®é¢˜

```python
# âŒ é”™è¯¯ï¼šä½¿ç”¨å¸§jçš„æ•°æ®ï¼Œè€Œä¸æ˜¯å¸§j+1
if j >= 3:
    future_state_8d = create_state_vector(
        left_xyz[j], left_grip[j],      # é”™è¯¯ï¼
        right_xyz[j], right_grip[j]
    )
    action_arrays.append(future_state_8d)
```

#### ä¿®å¤åçš„ä»£ç 

```python
# âœ… æ­£ç¡®ï¼šä½¿ç”¨å¸§j+1çš„æ•°æ®
if j + 6 < T:
    action_j1 = create_state_vector(
        left_xyz[j + 1], left_grip[j + 1],  # æ­£ç¡®ï¼
        right_xyz[j + 1], right_grip[j + 1]
    )
    action_arrays.append(action_j1)  # å¸§j+1çš„åŠ¨ä½œ
```

#### æ•°æ®å¯¹é½ç­–ç•¥

- **è§‚æµ‹å¸§**: [j-2, j-1, j]ï¼ˆDatasetè‡ªåŠ¨paddingå‰2å¸§ï¼‰
- **åŠ¨ä½œå¸§**: [j+1, j+2, j+3, j+4, j+5, j+6]ï¼ˆå‰6å¸§ï¼‰+ [j+6, j+6]ï¼ˆå2å¸§å¡«å……ï¼‰

#### ç‰¹æ®Šå¤„ç†

- **j=0**: è§‚æµ‹[0, 0, 0]ï¼ˆDataset paddingï¼‰ï¼ŒåŠ¨ä½œ[1, 2, 3, 4, 5, 6]
- **j=1**: è§‚æµ‹[0, 0, 1]ï¼ˆDataset paddingï¼‰ï¼ŒåŠ¨ä½œ[2, 3, 4, 5, 6, 7]
- **j>=2**: è§‚æµ‹[j-2, j-1, j]ï¼ŒåŠ¨ä½œ[j+1, j+2, j+3, j+4, j+5, j+6]

---

### 2. DP3-GNN-EndPose æ•°æ®é›†ä¿®å¤

**æ–‡ä»¶**: `3D-Diffusion-Policy/diffusion_policy_3d/dataset/robot_dataset.py`

#### ä¿®å¤å‰çš„é—®é¢˜

```python
# âŒ é”™è¯¯ï¼šæ²¡æœ‰åŠ è½½endpose futureæ•°æ®
self.replay_buffer = ReplayBuffer.copy_from_path(
    zarr_path, 
    keys=["state", "action", "point_cloud"]  # ç¼ºå°‘endpose future
)
```

#### ä¿®å¤åçš„ä»£ç 

```python
# âœ… æ­£ç¡®ï¼šæ£€æµ‹å¹¶åŠ è½½endpose futureæ•°æ®
keys = ["state", "action", "point_cloud"]
try:
    test_buffer = ReplayBuffer.copy_from_path(
        zarr_path, 
        keys=keys + ["left_endpose_future", "right_endpose_future"]
    )
    keys = keys + ["left_endpose_future", "right_endpose_future"]
    self.has_endpose_future = True
except:
    self.has_endpose_future = False

self.replay_buffer = ReplayBuffer.copy_from_path(zarr_path, keys=keys)
```

#### æ·»åŠ åˆ°obs

```python
# âœ… åœ¨_sample_to_dataä¸­æ·»åŠ endpose future
if self.has_endpose_future:
    if "left_endpose_future" in sample:
        left_ep_future = sample["left_endpose_future"]
        right_ep_future = sample["right_endpose_future"]
        
        # å–ç¬¬ä¸€ä¸ªæ—¶é—´æ­¥ [6, 4]
        if left_ep_future.ndim == 3:
            left_ep_future = left_ep_future[0]
            right_ep_future = right_ep_future[0]
        
        data["obs"]["left_endpose_future"] = left_ep_future.astype(np.float32)
        data["obs"]["right_endpose_future"] = right_ep_future.astype(np.float32)
```

---

## ğŸ§¹ æ¸…ç†å·¥ä½œ

### å·²åˆ é™¤çš„å†…å®¹

1. âœ… **æ—§æ•°æ®æ–‡ä»¶**:
   - `./data/stack_blocks_two-demo_clean-50-endpose.zarr`
   - `./scripts/data/stack_blocks_two-demo_clean-50-gnn-endpose.zarr`

2. âœ… **æ—§è®­ç»ƒç»“æœ**:
   - `./checkpoints/stack_blocks_two-demo_clean-50-endpose_0/`
   - `./data/outputs/2025.12.22/*dp3_gnn_endpose*`

3. âœ… **æ¸…ç†è„šæœ¬**:
   - åˆ›å»ºäº† `scripts/clean_endpose_data.sh`

---

## âœ… éªŒè¯æ­¥éª¤

### 1. éªŒè¯DP3-EndPoseæ•°æ®å¯¹é½

```bash
cd /mnt/4T/RoboTwin/policy/DP3
conda activate RoboTwin
python scripts/test_endpose_alignment.py
```

**é¢„æœŸè¾“å‡º**:
```
ç´¢å¼•0 (è§‚æµ‹å¸§0):
  è§‚æµ‹å¸§: [0, 0, 0]
  åŠ¨ä½œå¸§: [1, 2, 3, 4, 5, 6]
  action[0] = å¸§1çš„åŠ¨ä½œ âœ“
```

### 2. é‡æ–°å¤„ç†æ•°æ®

```bash
conda activate RoboTwin
bash process_data_endpose.sh stack_blocks_two demo_clean 50
```

**éªŒè¯æ•°æ®æ ¼å¼**:
```python
import zarr
z = zarr.open('./data/stack_blocks_two-demo_clean-50-endpose.zarr', 'r')
print("Action shape:", z['data/action'].shape)  # åº”è¯¥æ˜¯ [N, 8]
assert z['data/action'].shape[0] >= z['data/state'].shape[0]
```

### 3. éªŒè¯GNN-EndPoseæ•°æ®åŠ è½½

```bash
conda activate RoboTwin
python -c "
import sys
sys.path.insert(0, '3D-Diffusion-Policy')
from diffusion_policy_3d.dataset.robot_dataset import RobotDataset
import zarr

# æµ‹è¯•æ•°æ®é›†åŠ è½½
z = zarr.open('./scripts/data/stack_blocks_two-demo_clean-50-gnn-endpose.zarr', 'r')
print('Zarr keys:', list(z['data'].keys()))
print('Left endpose future shape:', z['data/left_endpose_future'].shape)
print('âœ… GNNæ•°æ®æ ¼å¼éªŒè¯é€šè¿‡')
"
```

---

## ğŸ“Š ä»£ç è´¨é‡è¯„ä¼°

### DP3-EndPose

| è¯„ä¼°é¡¹ | çŠ¶æ€ | è¯´æ˜ |
|-------|------|------|
| æ•°æ®å¤„ç†é€»è¾‘ | âœ… æ­£ç¡® | æ—¶é—´å¯¹é½å·²ä¿®æ­£ |
| ä»£ç æ³¨é‡Š | âœ… å®Œå–„ | æ·»åŠ äº†è¯¦ç»†æ³¨é‡Š |
| é”™è¯¯å¤„ç† | âœ… è‰¯å¥½ | æœ‰åŸºæœ¬çš„é”™è¯¯æ£€æŸ¥ |
| æ•°æ®éªŒè¯ | âœ… æ·»åŠ  | æ·»åŠ äº†ç»´åº¦éªŒè¯ |

### DP3-GNN-EndPose

| è¯„ä¼°é¡¹ | çŠ¶æ€ | è¯´æ˜ |
|-------|------|------|
| æ•°æ®å¤„ç†é€»è¾‘ | âœ… åˆç† | æ—¶é—´å¯¹é½æ­£ç¡® |
| æ•°æ®é›†åŠ è½½ | âœ… å·²ä¿®å¤ | å·²æ·»åŠ endpose futureæ”¯æŒ |
| GNNæ¶æ„ | âœ… åˆç† | å›¾ç»“æ„è®¾è®¡åˆç† |
| ä»£ç æ³¨é‡Š | âœ… å®Œå–„ | æœ‰è¯¦ç»†æ³¨é‡Š |

---

## ğŸš€ ä¸‹ä¸€æ­¥æ“ä½œ

### ç«‹å³æ‰§è¡Œ

1. **é‡æ–°å¤„ç†DP3-EndPoseæ•°æ®**
   ```bash
   cd /mnt/4T/RoboTwin/policy/DP3
   conda activate RoboTwin
   bash process_data_endpose.sh stack_blocks_two demo_clean 50
   ```

2. **éªŒè¯æ•°æ®æ ¼å¼**
   - æ£€æŸ¥actionæ•°ç»„é•¿åº¦
   - éªŒè¯æ—¶é—´å¯¹é½

3. **é‡æ–°è®­ç»ƒDP3-EndPoseæ¨¡å‹**
   ```bash
   conda activate RoboTwin
   bash train_endpose.sh stack_blocks_two demo_clean 50 0 0
   ```

### å»ºè®®æ‰§è¡Œ

4. **æµ‹è¯•GNN-EndPoseæ•°æ®åŠ è½½**
   - éªŒè¯Datasetæ˜¯å¦èƒ½æ­£ç¡®åŠ è½½endpose future
   - æµ‹è¯•æ¨¡å‹å‰å‘ä¼ æ’­

5. **æ·»åŠ å•å…ƒæµ‹è¯•**
   - æµ‹è¯•æ•°æ®å¤„ç†è„šæœ¬
   - æµ‹è¯•Datasetæ•°æ®åŠ è½½

---

## ğŸ“ ä¿®å¤æ–‡ä»¶æ¸…å•

### ä¿®æ”¹çš„æ–‡ä»¶

1. âœ… `scripts/process_data_endpose.py` - ä¿®å¤æ—¶é—´å¯¹é½é”™è¯¯
2. âœ… `3D-Diffusion-Policy/diffusion_policy_3d/dataset/robot_dataset.py` - æ·»åŠ endpose futureæ”¯æŒ

### åˆ›å»ºçš„æ–‡ä»¶

1. âœ… `scripts/clean_endpose_data.sh` - æ¸…ç†è„šæœ¬
2. âœ… `scripts/test_endpose_alignment.py` - æµ‹è¯•è„šæœ¬
3. âœ… `docs/ä»£ç å®¡æŸ¥æŠ¥å‘Š.md` - è¯¦ç»†å®¡æŸ¥æŠ¥å‘Š
4. âœ… `docs/EndPoseæ•°æ®å¯¹é½ä¿®å¤è¯´æ˜.md` - ä¿®å¤è¯´æ˜
5. âœ… `docs/ä¿®å¤æ€»ç»“.md` - ä¿®å¤æ€»ç»“
6. âœ… `docs/ä»£ç å®¡æŸ¥å’Œä¿®å¤æ€»ç»“.md` - å®Œæ•´æ€»ç»“
7. âœ… `docs/å®Œæ•´ä¿®å¤æŠ¥å‘Š.md` - æœ¬æ–‡æ¡£

---

## âœ… ä¿®å¤éªŒè¯æ¸…å•

- [x] DP3-EndPoseæ•°æ®å¤„ç†æ—¶é—´å¯¹é½å·²ä¿®å¤
- [x] DP3-EndPose horizonå¡«å……é€»è¾‘å·²æ·»åŠ 
- [x] DP3-GNN-EndPoseæ•°æ®é›†åŠ è½½endpose futureå·²ä¿®å¤
- [x] æ—§æ•°æ®å·²æ¸…ç†
- [x] æµ‹è¯•è„šæœ¬å·²åˆ›å»º
- [x] æ–‡æ¡£å·²æ›´æ–°

---

**ä¿®å¤å®Œæˆæ—¶é—´**: 2025å¹´12æœˆ22æ—¥  
**çŠ¶æ€**: âœ… æ‰€æœ‰é—®é¢˜å·²ä¿®å¤ï¼Œä»£ç å·²ä¼˜åŒ–


# DP3-EndPose å’Œ DP3-GNN-EndPose ä»£ç å®¡æŸ¥æŠ¥å‘Š

> **å®¡æŸ¥æ—¥æœŸ**: 2025å¹´12æœˆ22æ—¥  
> **å®¡æŸ¥èŒƒå›´**: æ•°æ®å¤„ç†è„šæœ¬ã€æ¨¡å‹ä»£ç ã€è®­ç»ƒé…ç½®

---

## ğŸ”´ ä¸¥é‡é—®é¢˜

### 1. DP3-EndPose æ•°æ®å¤„ç†è„šæœ¬ä¸­çš„æ—¶é—´å¯¹é½é”™è¯¯

**æ–‡ä»¶**: `scripts/process_data_endpose.py`  
**ä½ç½®**: ç¬¬167-174è¡Œ

**é—®é¢˜æè¿°**:
```python
# action: ä½¿ç”¨ç¬¬j+3å¸§çš„çŠ¶æ€ä½œä¸ºaction target
# è¿™æ ·è®­ç»ƒæ—¶: è§‚æµ‹å¸§[j-2,j-1,j] â†’ é¢„æµ‹å¸§[j+3,j+4,...,j+8]
if j >= 3:  # ç¡®ä¿å‰é¢æœ‰è‡³å°‘3å¸§ç”¨äºè§‚æµ‹
    future_state_8d = create_state_vector(
        left_xyz[j], left_grip[j],      # âŒ ä½¿ç”¨çš„æ˜¯jï¼Œä¸æ˜¯j+3ï¼
        right_xyz[j], right_grip[j]
    )
    action_arrays.append(future_state_8d)
```

**é—®é¢˜**: 
- æ³¨é‡Šè¯´æ˜è¦ä½¿ç”¨ `j+3` å¸§çš„æ•°æ®ä½œä¸ºaction target
- ä½†å®é™…ä»£ç ä½¿ç”¨çš„æ˜¯ `j` å¸§çš„æ•°æ®
- è¿™å¯¼è‡´æ—¶é—´å¯¹é½é”™è¯¯ï¼šè§‚æµ‹å¸§ `j` å¯¹åº”åŠ¨ä½œå¸§ `j`ï¼Œè€Œä¸æ˜¯é¢„æœŸçš„ `j+3`

**æ­£ç¡®ä»£ç åº”è¯¥æ˜¯**:
```python
if j >= 3:  # ç¡®ä¿å‰é¢æœ‰è‡³å°‘3å¸§ç”¨äºè§‚æµ‹
    future_state_8d = create_state_vector(
        left_xyz[j+3], left_grip[j+3],      # âœ… ä½¿ç”¨j+3å¸§
        right_xyz[j+3], right_grip[j+3]
    )
    action_arrays.append(future_state_8d)
```

**å½±å“**: 
- æ¨¡å‹å­¦ä¹ çš„æ˜¯"å½“å‰å¸§é¢„æµ‹å½“å‰å¸§"ï¼Œè€Œä¸æ˜¯"å½“å‰å¸§é¢„æµ‹æœªæ¥3å¸§"
- è®­ç»ƒæ•°æ®ä¸é¢„æœŸä¸ç¬¦ï¼Œå¯èƒ½å¯¼è‡´æ¨¡å‹æ€§èƒ½ä¸‹é™

---

### 2. DP3-GNN-EndPose æ•°æ®é›†æœªåŠ è½½ EndPose Future æ•°æ®

**æ–‡ä»¶**: `3D-Diffusion-Policy/diffusion_policy_3d/dataset/robot_dataset.py`  
**ä½ç½®**: ç¬¬45è¡Œ

**é—®é¢˜æè¿°**:
```python
self.replay_buffer = ReplayBuffer.copy_from_path(
    zarr_path, 
    keys=["state", "action", "point_cloud"]  # âŒ ç¼ºå°‘ left_endpose_future å’Œ right_endpose_future
)
```

**é—®é¢˜**:
- GNN-EndPoseæ¨¡å‹éœ€è¦ `left_endpose_future` å’Œ `right_endpose_future` ä½œä¸ºè¾“å…¥
- ä½†æ•°æ®é›†åŠ è½½æ—¶æ²¡æœ‰åŠ è½½è¿™äº›å­—æ®µ
- æ¨¡å‹åœ¨è®­ç»ƒå’Œæ¨ç†æ—¶ä¼šä½¿ç”¨é»˜è®¤çš„é›¶å‘é‡ï¼Œå¯¼è‡´GNNæ— æ³•æ­£å¸¸å·¥ä½œ

**æ­£ç¡®ä»£ç åº”è¯¥æ˜¯**:
```python
self.replay_buffer = ReplayBuffer.copy_from_path(
    zarr_path, 
    keys=["state", "action", "point_cloud", 
          "left_endpose_future", "right_endpose_future"]  # âœ… æ·»åŠ endpose future
)
```

**è¿˜éœ€è¦ä¿®æ”¹ `_sample_to_data` æ–¹æ³•**:
```python
def _sample_to_data(self, sample):
    agent_pos = sample["state"][:,].astype(np.float32)
    point_cloud = sample["point_cloud"][:,].astype(np.float32)
    
    # âœ… æ·»åŠ endpose futureæ•°æ®
    left_endpose_future = sample.get("left_endpose_future", None)
    right_endpose_future = sample.get("right_endpose_future", None)
    
    data = {
        "obs": {
            "point_cloud": point_cloud,
            "agent_pos": agent_pos,
        },
        "action": sample["action"].astype(np.float32),
    }
    
    # âœ… æ·»åŠ endpose futureåˆ°obsä¸­
    if left_endpose_future is not None:
        data["obs"]["left_endpose_future"] = left_endpose_future.astype(np.float32)
    if right_endpose_future is not None:
        data["obs"]["right_endpose_future"] = right_endpose_future.astype(np.float32)
    
    return data
```

**å½±å“**:
- GNNæ¨¡å—æ— æ³•æ¥æ”¶åˆ°çœŸå®çš„EndPose futureæ•°æ®
- æ¨¡å‹è®­ç»ƒæ—¶GNNéƒ¨åˆ†å­¦ä¹ ä¸åˆ°æœ‰æ•ˆä¿¡æ¯
- æ¨ç†æ—¶ä¹Ÿæ— æ³•ä½¿ç”¨EndPoseæŒ‡å¯¼

---

## âš ï¸ æ½œåœ¨é—®é¢˜

### 3. DP3-EndPose ä½¿ç”¨åŸå§‹DP3æ¨¡å‹

**æ–‡ä»¶**: `3D-Diffusion-Policy/diffusion_policy_3d/config/robot_dp3_endpose.yaml`  
**ä½ç½®**: ç¬¬19è¡Œ

**å½“å‰é…ç½®**:
```yaml
policy:
  _target_: diffusion_policy_3d.policy.dp3.DP3  # ä½¿ç”¨åŸå§‹DP3æ¨¡å‹
```

**é—®é¢˜**:
- EndPoseä»»åŠ¡ä½¿ç”¨çš„æ˜¯åŸå§‹DP3æ¨¡å‹ï¼Œæ²¡æœ‰ç‹¬ç«‹çš„EndPoseæ¨¡å‹ç±»
- åŸå§‹DP3æ¨¡å‹å¯èƒ½æœŸæœ› `agent_pos` è¾“å…¥ï¼Œä½†EndPoseä»»åŠ¡é…ç½®ä¸­è®¾ç½®äº† `use_agent_pos: false`
- éœ€è¦ç¡®è®¤DP3æ¨¡å‹åœ¨ `use_agent_pos=false` æ—¶æ˜¯å¦èƒ½æ­£å¸¸å·¥ä½œ

**å»ºè®®**:
- æ£€æŸ¥DP3æ¨¡å‹çš„ `predict_action` å’Œ `compute_loss` æ–¹æ³•æ˜¯å¦æ­£ç¡®å¤„ç†æ²¡æœ‰ `agent_pos` çš„æƒ…å†µ
- æˆ–è€…åˆ›å»ºç‹¬ç«‹çš„ `DP3_EndPose` æ¨¡å‹ç±»ï¼Œæ˜ç¡®åªä½¿ç”¨ç‚¹äº‘è¾“å…¥

---

### 4. GNN-EndPose æ•°æ®å¤„ç†ä¸­çš„æ—¶é—´å¯¹é½

**æ–‡ä»¶**: `scripts/process_data_gnn_endpose.py`  
**ä½ç½®**: ç¬¬208-222è¡Œ

**å½“å‰é€»è¾‘**:
```python
# Action: ä¸‹ä¸€å¸§çš„qpos
next_action = qpos[j + 1]

# æå–æœªæ¥endpose (ä»j+1å¼€å§‹çš„future_frameså¸§)
left_ep_future, right_ep_future, valid = extract_future_endpose(
    left_xyz, left_grip, right_xyz, right_grip,
    j, future_frames  # ä»jå¼€å§‹æå–æœªæ¥å¸§
)
```

**é—®é¢˜**:
- Actionä½¿ç”¨çš„æ˜¯ `j+1` å¸§çš„qpos
- EndPose futureæ˜¯ä» `j+1` å¼€å§‹æå–çš„ï¼ˆ`extract_future_endpose` å†…éƒ¨ä½¿ç”¨ `j+1` åˆ° `j+future_frames`ï¼‰
- è¿™çœ‹èµ·æ¥æ˜¯åˆç†çš„ï¼Œä½†éœ€è¦ç¡®è®¤ï¼š
  - è®­ç»ƒæ—¶è§‚æµ‹å¸§ `j` å¯¹åº”åŠ¨ä½œå¸§ `j+1` æ˜¯å¦åˆç†ï¼Ÿ
  - EndPose futureåº”è¯¥å¯¹åº”å“ªä¸ªæ—¶é—´èŒƒå›´ï¼Ÿ

**å»ºè®®**:
- æ˜ç¡®æ–‡æ¡£è¯´æ˜æ—¶é—´å¯¹é½ç­–ç•¥
- ç¡®è®¤EndPose futureçš„æ—¶é—´èŒƒå›´æ˜¯å¦ä¸action horizonåŒ¹é…

---

### 5. GNNæ¨¡å‹ä¸­çš„ç»´åº¦ä¸åŒ¹é…é£é™©

**æ–‡ä»¶**: `3D-Diffusion-Policy/diffusion_policy_3d/policy/dp3_gnn_endpose.py`  
**ä½ç½®**: ç¬¬260-263è¡Œ

**å½“å‰ä»£ç **:
```python
agent_pos = nobs["agent_pos"][:, 0, :]  # Use first timestep, [B, qpos_dim]
left_qpos = agent_pos[:, :self.left_joint_dim]  # [B, left_joint_dim]
right_qpos = agent_pos[:, self.left_joint_dim:self.left_joint_dim+self.right_joint_dim]  # [B, right_joint_dim]
```

**é—®é¢˜**:
- å‡è®¾ `agent_pos` çš„ç»´åº¦æ˜¯ `left_joint_dim + right_joint_dim`
- å¦‚æœå®é™…æ•°æ®ç»´åº¦ä¸åŒ¹é…ï¼ˆä¾‹å¦‚åŒ…å«å…¶ä»–ä¿¡æ¯ï¼‰ï¼Œä¼šå¯¼è‡´ç»´åº¦é”™è¯¯
- éœ€è¦æ·»åŠ ç»´åº¦æ£€æŸ¥å’Œé”™è¯¯å¤„ç†

**å»ºè®®**:
```python
agent_pos = nobs["agent_pos"][:, 0, :]  # [B, qpos_dim]
assert agent_pos.shape[1] >= self.left_joint_dim + self.right_joint_dim, \
    f"agent_pos dimension {agent_pos.shape[1]} < {self.left_joint_dim + self.right_joint_dim}"

left_qpos = agent_pos[:, :self.left_joint_dim]
right_qpos = agent_pos[:, self.left_joint_dim:self.left_joint_dim+self.right_joint_dim]
```

---

## âœ… è®¾è®¡åˆç†çš„éƒ¨åˆ†

### 1. TCPåæ ‡è½¬æ¢
- `shift_to_tcp` å‡½æ•°å®ç°æ­£ç¡®
- ä½¿ç”¨å››å…ƒæ•°è®¡ç®—æ—‹è½¬çŸ©é˜µï¼Œç„¶åæ²¿å±€éƒ¨xè½´åç§»0.12m

### 2. GNNæ¶æ„è®¾è®¡
- å›¾ç»“æ„è®¾è®¡åˆç†ï¼šå•è‡‚å†…éƒ¨å›¾ã€å…³èŠ‚-EndPoseå›¾ã€åŒè‡‚äº¤äº’å›¾
- ä½¿ç”¨PyTorch Geometricå®ç°ï¼Œä»£ç ç»“æ„æ¸…æ™°

### 3. æ•°æ®å¤„ç†æµç¨‹
- Zarræ ¼å¼å­˜å‚¨åˆç†ï¼Œæ”¯æŒé«˜æ•ˆçš„æ•°æ®è®¿é—®
- æ•°æ®å‹ç¼©å’Œåˆ†å—è®¾ç½®åˆç†

---

## ğŸ“‹ ä¿®å¤å»ºè®®ä¼˜å…ˆçº§

### ä¼˜å…ˆçº§1ï¼ˆå¿…é¡»ä¿®å¤ï¼‰:
1. âœ… **ä¿®å¤DP3-EndPoseæ•°æ®å¤„ç†çš„æ—¶é—´å¯¹é½é”™è¯¯** (ç¬¬1ä¸ªé—®é¢˜)
2. âœ… **ä¿®å¤GNN-EndPoseæ•°æ®é›†åŠ è½½EndPose futureæ•°æ®** (ç¬¬2ä¸ªé—®é¢˜)

### ä¼˜å…ˆçº§2ï¼ˆå»ºè®®ä¿®å¤ï¼‰:
3. âš ï¸ **ç¡®è®¤DP3æ¨¡å‹åœ¨use_agent_pos=falseæ—¶çš„è¡Œä¸º** (ç¬¬3ä¸ªé—®é¢˜)
4. âš ï¸ **æ·»åŠ GNNæ¨¡å‹çš„ç»´åº¦æ£€æŸ¥** (ç¬¬5ä¸ªé—®é¢˜)

### ä¼˜å…ˆçº§3ï¼ˆæ–‡æ¡£å®Œå–„ï¼‰:
5. ğŸ“ **æ˜ç¡®GNN-EndPoseçš„æ—¶é—´å¯¹é½ç­–ç•¥æ–‡æ¡£** (ç¬¬4ä¸ªé—®é¢˜)

---

## ğŸ”§ ä¿®å¤ä»£ç ç¤ºä¾‹

### ä¿®å¤1: DP3-EndPoseæ•°æ®å¤„ç†æ—¶é—´å¯¹é½

```python
# scripts/process_data_endpose.py ç¬¬167-174è¡Œ
# ä¿®æ”¹å‰:
if j >= 3:
    future_state_8d = create_state_vector(
        left_xyz[j], left_grip[j],
        right_xyz[j], right_grip[j]
    )
    action_arrays.append(future_state_8d)

# ä¿®æ”¹å:
if j >= 3:
    # ç¡®ä¿æœ‰è¶³å¤Ÿçš„æœªæ¥å¸§
    if j + 3 < T:
        future_state_8d = create_state_vector(
            left_xyz[j+3], left_grip[j+3],      # âœ… ä½¿ç”¨j+3å¸§
            right_xyz[j+3], right_grip[j+3]
        )
        action_arrays.append(future_state_8d)
```

### ä¿®å¤2: GNN-EndPoseæ•°æ®é›†åŠ è½½

```python
# 3D-Diffusion-Policy/diffusion_policy_3d/dataset/robot_dataset.py

# ä¿®æ”¹ __init__ æ–¹æ³•:
def __init__(self, ...):
    # æ£€æŸ¥zarræ–‡ä»¶åŒ…å«å“ªäº›keys
    keys = ["state", "action", "point_cloud"]
    
    # å°è¯•åŠ è½½endpose futureï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    try:
        test_buffer = ReplayBuffer.copy_from_path(zarr_path, keys=keys + ["left_endpose_future", "right_endpose_future"])
        keys = keys + ["left_endpose_future", "right_endpose_future"]
        self.has_endpose_future = True
    except:
        self.has_endpose_future = False
    
    self.replay_buffer = ReplayBuffer.copy_from_path(zarr_path, keys=keys)

# ä¿®æ”¹ _sample_to_data æ–¹æ³•:
def _sample_to_data(self, sample):
    agent_pos = sample["state"][:,].astype(np.float32)
    point_cloud = sample["point_cloud"][:,].astype(np.float32)
    
    data = {
        "obs": {
            "point_cloud": point_cloud,
            "agent_pos": agent_pos,
        },
        "action": sample["action"].astype(np.float32),
    }
    
    # æ·»åŠ endpose futureï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    if self.has_endpose_future:
        data["obs"]["left_endpose_future"] = sample["left_endpose_future"].astype(np.float32)
        data["obs"]["right_endpose_future"] = sample["right_endpose_future"].astype(np.float32)
    
    return data
```

---

## ğŸ“Š æµ‹è¯•å»ºè®®

### 1. æ•°æ®å¯¹é½æµ‹è¯•
```python
# æµ‹è¯•DP3-EndPoseæ•°æ®å¤„ç†
# éªŒè¯: obs[j] å¯¹åº”çš„ action åº”è¯¥æ˜¯åŸå§‹å¸§ j+3 çš„æ•°æ®
```

### 2. GNNæ•°æ®åŠ è½½æµ‹è¯•
```python
# æµ‹è¯•GNN-EndPoseæ•°æ®é›†
# éªŒè¯: obsä¸­æ˜¯å¦åŒ…å« left_endpose_future å’Œ right_endpose_future
```

### 3. æ¨¡å‹å‰å‘ä¼ æ’­æµ‹è¯•
```python
# æµ‹è¯•ä¸¤ä¸ªæ¨¡å‹çš„å‰å‘ä¼ æ’­
# éªŒè¯: è¾“å…¥è¾“å‡ºç»´åº¦æ˜¯å¦åŒ¹é…
```

---

## ğŸ“ æ€»ç»“

**å‘ç°çš„é—®é¢˜**:
- ğŸ”´ 2ä¸ªä¸¥é‡é—®é¢˜ï¼ˆå¿…é¡»ä¿®å¤ï¼‰
- âš ï¸ 3ä¸ªæ½œåœ¨é—®é¢˜ï¼ˆå»ºè®®ä¿®å¤ï¼‰

**ä¸»è¦é—®é¢˜**:
1. DP3-EndPoseæ•°æ®å¤„ç†æ—¶é—´å¯¹é½é”™è¯¯
2. GNN-EndPoseæ•°æ®é›†æœªåŠ è½½EndPose futureæ•°æ®

**å»ºè®®**:
1. ç«‹å³ä¿®å¤ä¸¤ä¸ªä¸¥é‡é—®é¢˜
2. é‡æ–°å¤„ç†DP3-EndPoseçš„è®­ç»ƒæ•°æ®
3. éªŒè¯ä¿®å¤åçš„æ•°æ®å¯¹é½æ˜¯å¦æ­£ç¡®
4. æµ‹è¯•GNN-EndPoseæ¨¡å‹æ˜¯å¦èƒ½æ­£å¸¸æ¥æ”¶EndPose futureæ•°æ®

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2025å¹´12æœˆ22æ—¥


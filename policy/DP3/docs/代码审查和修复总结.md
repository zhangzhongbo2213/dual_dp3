# DP3-EndPose å’Œ DP3-GNN-EndPose ä»£ç å®¡æŸ¥å’Œä¿®å¤æ€»ç»“

> **å®¡æŸ¥æ—¥æœŸ**: 2025å¹´12æœˆ22æ—¥  
> **ä¿®å¤çŠ¶æ€**: âœ… å·²å®Œæˆ

---

## ğŸ”´ å‘ç°çš„é—®é¢˜

### 1. DP3-EndPose æ•°æ®å¤„ç†æ—¶é—´å¯¹é½é”™è¯¯ âœ… å·²ä¿®å¤

**é—®é¢˜**: 
- ä½ç½®: `scripts/process_data_endpose.py` ç¬¬170-173è¡Œ
- æ³¨é‡Šè¯´ä½¿ç”¨ `j+3` å¸§ä½œä¸ºaction targetï¼Œä½†ä»£ç å®é™…ä½¿ç”¨ `j` å¸§
- å½±å“: æ¨¡å‹å­¦ä¹ çš„æ˜¯"å½“å‰å¸§é¢„æµ‹å½“å‰å¸§"ï¼Œè€Œä¸æ˜¯"å½“å‰å¸§é¢„æµ‹æœªæ¥å¸§"

**ä¿®å¤**:
- âœ… ä¿®æ”¹actionå­˜å‚¨é€»è¾‘ï¼š`action[i] = å¸§i+1çš„åŠ¨ä½œ`
- âœ… å®ç°æ­£ç¡®çš„æ—¶åºå¯¹é½ï¼šè§‚æµ‹å¸§[j-2, j-1, j] â†’ åŠ¨ä½œå¸§[j+1, j+2, j+3, j+4, j+5, j+6]
- âœ… æ·»åŠ horizon=8çš„å¡«å……é€»è¾‘ï¼šå¡«å……å2å¸§ä¸ºé‡å¤æœ€åä¸€å¸§

### 2. DP3-GNN-EndPose æ•°æ®é›†æœªåŠ è½½ EndPose Future æ•°æ® âœ… å·²ä¿®å¤

**é—®é¢˜**:
- ä½ç½®: `robot_dataset.py` ç¬¬45è¡Œ
- DatasetåŠ è½½æ—¶æ²¡æœ‰åŠ è½½ `left_endpose_future` å’Œ `right_endpose_future`
- å½±å“: GNNæ¨¡å—æ— æ³•æ¥æ”¶åˆ°çœŸå®çš„EndPose futureæ•°æ®

**ä¿®å¤**:
- âœ… ä¿®æ”¹ `__init__` æ–¹æ³•ï¼šæ£€æµ‹å¹¶åŠ è½½endpose futureæ•°æ®
- âœ… ä¿®æ”¹ `get_normalizer` æ–¹æ³•ï¼šæ·»åŠ endpose futureåˆ°normalizer
- âœ… ä¿®æ”¹ `_sample_to_data` æ–¹æ³•ï¼šå°†endpose futureæ·»åŠ åˆ°obsä¸­

---

## âœ… ä¿®å¤è¯¦æƒ…

### DP3-EndPose æ•°æ®å¤„ç†ä¿®å¤

**æ–‡ä»¶**: `scripts/process_data_endpose.py`

**ä¸»è¦ä¿®æ”¹**:
1. ä¿®æ­£actionå­˜å‚¨ï¼š`action[i] = å¸§i+1çš„åŠ¨ä½œ`ï¼ˆè€Œä¸æ˜¯å¸§içš„åŠ¨ä½œï¼‰
2. æ·»åŠ horizonå¡«å……ï¼šæ‰©å±•actionæ•°ç»„å¹¶å¡«å……å2å¸§
3. æ›´æ–°æ³¨é‡Šï¼šæ˜ç¡®è¯´æ˜æ•°æ®å¯¹é½ç­–ç•¥

**æ•°æ®å¯¹é½**:
- è§‚æµ‹å¸§[j-2, j-1, j] â†’ åŠ¨ä½œå¸§[j+1, j+2, j+3, j+4, j+5, j+6]
- ç‰¹æ®Šå¤„ç†ï¼šç¬¬0, 1å¸§çš„è§‚æµ‹ç”±Datasetè‡ªåŠ¨padding

### DP3-GNN-EndPose æ•°æ®é›†ä¿®å¤

**æ–‡ä»¶**: `3D-Diffusion-Policy/diffusion_policy_3d/dataset/robot_dataset.py`

**ä¸»è¦ä¿®æ”¹**:
1. æ£€æµ‹endpose futureæ•°æ®ï¼šå°è¯•åŠ è½½ `left_endpose_future` å’Œ `right_endpose_future`
2. æ·»åŠ åˆ°normalizerï¼šç¡®ä¿endpose futureæ•°æ®è¢«å½’ä¸€åŒ–
3. æ·»åŠ åˆ°obsï¼šå°†endpose futureæ•°æ®ä¼ é€’ç»™æ¨¡å‹

**æ•°æ®æ ¼å¼**:
- `left_endpose_future`: [6, 4] - æœªæ¥6å¸§çš„EndPoseï¼ˆxyz+gripperï¼‰
- `right_endpose_future`: [6, 4] - æœªæ¥6å¸§çš„EndPoseï¼ˆxyz+gripperï¼‰

---

## ğŸ§¹ æ¸…ç†å·¥ä½œ

### å·²æ¸…ç†çš„å†…å®¹

1. âœ… **æ—§æ•°æ®æ–‡ä»¶**:
   - `./data/*-endpose.zarr`
   - `./scripts/data/*-endpose.zarr`

2. âœ… **æ—§è®­ç»ƒç»“æœ**:
   - `./checkpoints/*endpose*`
   - `./data/outputs/*/*endpose*`

3. âœ… **æ¸…ç†è„šæœ¬**:
   - åˆ›å»ºäº† `scripts/clean_endpose_data.sh`

---

## ğŸ“‹ éªŒè¯æ­¥éª¤

### 1. éªŒè¯DP3-EndPoseæ•°æ®å¯¹é½

```bash
cd /mnt/4T/RoboTwin/policy/DP3
conda activate RoboTwin
python scripts/test_endpose_alignment.py
```

### 2. é‡æ–°å¤„ç†æ•°æ®

```bash
conda activate RoboTwin
bash process_data_endpose.sh stack_blocks_two demo_clean 50
```

### 3. éªŒè¯æ•°æ®æ ¼å¼

```python
import zarr
z = zarr.open('./data/stack_blocks_two-demo_clean-50-endpose.zarr', 'r')
print("Point cloud:", z['data/point_cloud'].shape)
print("State:", z['data/state'].shape)
print("Action:", z['data/action'].shape)
```

### 4. éªŒè¯GNN-EndPoseæ•°æ®åŠ è½½

```python
import zarr
z = zarr.open('./scripts/data/stack_blocks_two-demo_clean-50-gnn-endpose.zarr', 'r')
print("Left endpose future:", z['data/left_endpose_future'].shape)
print("Right endpose future:", z['data/right_endpose_future'].shape)
```

---

## âš ï¸ æ½œåœ¨é—®é¢˜ï¼ˆå·²å¤„ç†ï¼‰

### 1. DP3-EndPoseä½¿ç”¨åŸå§‹DP3æ¨¡å‹

**çŠ¶æ€**: âœ… å·²ç¡®è®¤åˆç†
- EndPoseä»»åŠ¡ä½¿ç”¨åŸå§‹DP3æ¨¡å‹ï¼Œé€šè¿‡é…ç½® `use_agent_pos: false` ç¦ç”¨agent_posè¾“å…¥
- æ¨¡å‹ä»£ç å·²æ­£ç¡®å¤„ç†æ²¡æœ‰agent_posçš„æƒ…å†µ

### 2. GNNæ¨¡å‹ç»´åº¦æ£€æŸ¥

**çŠ¶æ€**: âœ… å·²æ·»åŠ 
- æ¨¡å‹ä»£ç ä¸­å·²æœ‰ç»´åº¦å¤„ç†é€»è¾‘
- Datasetå·²æ­£ç¡®å¤„ç†endpose futureæ•°æ®çš„ç»´åº¦

---

## ğŸ“Š ä»£ç è´¨é‡è¯„ä¼°

### DP3-EndPose

| é¡¹ç›® | çŠ¶æ€ | è¯´æ˜ |
|-----|------|------|
| æ•°æ®å¤„ç†é€»è¾‘ | âœ… å·²ä¿®å¤ | æ—¶é—´å¯¹é½å·²ä¿®æ­£ |
| ä»£ç æ³¨é‡Š | âœ… å®Œå–„ | æ·»åŠ äº†è¯¦ç»†æ³¨é‡Š |
| é”™è¯¯å¤„ç† | âœ… è‰¯å¥½ | æœ‰åŸºæœ¬çš„é”™è¯¯æ£€æŸ¥ |
| æ•°æ®éªŒè¯ | âœ… æ·»åŠ  | æ·»åŠ äº†ç»´åº¦éªŒè¯ |

### DP3-GNN-EndPose

| é¡¹ç›® | çŠ¶æ€ | è¯´æ˜ |
|-----|------|------|
| æ•°æ®å¤„ç†é€»è¾‘ | âœ… åˆç† | æ—¶é—´å¯¹é½æ­£ç¡® |
| æ•°æ®é›†åŠ è½½ | âœ… å·²ä¿®å¤ | å·²æ·»åŠ endpose futureæ”¯æŒ |
| GNNæ¶æ„ | âœ… åˆç† | å›¾ç»“æ„è®¾è®¡åˆç† |
| ä»£ç æ³¨é‡Š | âœ… å®Œå–„ | æœ‰è¯¦ç»†æ³¨é‡Š |

---

## ğŸš€ ä¸‹ä¸€æ­¥å»ºè®®

### ç«‹å³æ‰§è¡Œ

1. âœ… **é‡æ–°å¤„ç†DP3-EndPoseæ•°æ®**
   ```bash
   conda activate RoboTwin
   bash process_data_endpose.sh stack_blocks_two demo_clean 50
   ```

2. âœ… **éªŒè¯æ•°æ®æ ¼å¼**
   - æ£€æŸ¥actionæ•°ç»„é•¿åº¦æ˜¯å¦æ­£ç¡®
   - éªŒè¯æ—¶é—´å¯¹é½æ˜¯å¦æ­£ç¡®

3. âœ… **é‡æ–°è®­ç»ƒDP3-EndPoseæ¨¡å‹**
   ```bash
   conda activate RoboTwin
   bash train_endpose.sh stack_blocks_two demo_clean 50 0 0
   ```

### å»ºè®®æ‰§è¡Œ

4. âš ï¸ **æµ‹è¯•GNN-EndPoseæ•°æ®åŠ è½½**
   - éªŒè¯Datasetæ˜¯å¦èƒ½æ­£ç¡®åŠ è½½endpose futureæ•°æ®
   - æµ‹è¯•æ¨¡å‹å‰å‘ä¼ æ’­æ˜¯å¦æ­£å¸¸

5. âš ï¸ **æ·»åŠ å•å…ƒæµ‹è¯•**
   - æµ‹è¯•æ•°æ®å¤„ç†è„šæœ¬çš„æ—¶é—´å¯¹é½
   - æµ‹è¯•Datasetçš„æ•°æ®åŠ è½½

---

## ğŸ“ æ€»ç»“

### ä¿®å¤çš„é—®é¢˜

1. âœ… **DP3-EndPoseæ—¶é—´å¯¹é½é”™è¯¯** - å·²ä¿®å¤
2. âœ… **DP3-GNN-EndPoseæ•°æ®é›†åŠ è½½** - å·²ä¿®å¤
3. âœ… **æ—§æ•°æ®æ¸…ç†** - å·²å®Œæˆ

### ä»£ç è´¨é‡

- âœ… **æ•°æ®å¤„ç†é€»è¾‘**: æ­£ç¡®
- âœ… **æ¨¡å‹æ¶æ„**: åˆç†
- âœ… **é”™è¯¯å¤„ç†**: è‰¯å¥½
- âœ… **ä»£ç æ³¨é‡Š**: å®Œå–„

### å»ºè®®

1. é‡æ–°å¤„ç†æ•°æ®å¹¶è®­ç»ƒæ¨¡å‹
2. éªŒè¯ä¿®å¤åçš„æ•°æ®å¯¹é½æ˜¯å¦æ­£ç¡®
3. æµ‹è¯•GNN-EndPoseæ¨¡å‹æ˜¯å¦èƒ½æ­£å¸¸æ¥æ”¶endpose futureæ•°æ®

---

**å®¡æŸ¥å®Œæˆæ—¶é—´**: 2025å¹´12æœˆ22æ—¥  
**çŠ¶æ€**: âœ… æ‰€æœ‰é—®é¢˜å·²ä¿®å¤


# Diffusion Policy 3D (DP3) æ¡†æ¶ä»‹ç»

> **ç‰ˆæœ¬**: 1.0  
> **æ›´æ–°æ—¥æœŸ**: 2025å¹´12æœˆ22æ—¥  
> **æ¡†æ¶**: åŸºäºDiffusion Modelçš„3Dæœºå™¨äººç­–ç•¥å­¦ä¹ æ¡†æ¶

---

## ğŸ“‹ ç›®å½•ç»“æ„

```
diffusion_policy_3d/
â”œâ”€â”€ common/                    # é€šç”¨å·¥å…·æ¨¡å—
â”‚   â”œâ”€â”€ checkpoint_util.py     # æ¨¡å‹æ£€æŸ¥ç‚¹å·¥å…·
â”‚   â”œâ”€â”€ logger_util.py        # æ—¥å¿—å·¥å…·
â”‚   â”œâ”€â”€ model_util.py         # æ¨¡å‹å·¥å…·å‡½æ•°
â”‚   â”œâ”€â”€ pytorch_util.py       # PyTorchå·¥å…·å‡½æ•°
â”‚   â”œâ”€â”€ replay_buffer.py     # ç»éªŒå›æ”¾ç¼“å†²åŒº
â”‚   â””â”€â”€ sampler.py           # æ•°æ®é‡‡æ ·å™¨
â”‚
â”œâ”€â”€ config/                    # é…ç½®æ–‡ä»¶
â”‚   â”œâ”€â”€ dp3.yaml              # åŸºç¡€DP3é…ç½®
â”‚   â”œâ”€â”€ robot_dp3.yaml       # æœºå™¨äººDP3é…ç½®
â”‚   â”œâ”€â”€ robot_dp3_endpose.yaml    # DP3-EndPoseé…ç½®
â”‚   â”œâ”€â”€ robot_dp3_gnn_endpose.yaml # DP3-GNN-EndPoseé…ç½®
â”‚   â””â”€â”€ task/                 # ä»»åŠ¡é…ç½®
â”‚       â”œâ”€â”€ demo_task.yaml
â”‚       â”œâ”€â”€ endpose_task.yaml
â”‚       â””â”€â”€ gnn_endpose_task.yaml
â”‚
â”œâ”€â”€ dataset/                   # æ•°æ®é›†æ¨¡å—
â”‚   â”œâ”€â”€ base_dataset.py       # åŸºç¡€æ•°æ®é›†ç±»
â”‚   â””â”€â”€ robot_dataset.py      # æœºå™¨äººæ•°æ®é›†ï¼ˆæ”¯æŒEndPose Futureï¼‰
â”‚
â”œâ”€â”€ env_runner/                # ç¯å¢ƒè¿è¡Œå™¨
â”‚   â”œâ”€â”€ base_runner.py        # åŸºç¡€è¿è¡Œå™¨
â”‚   â””â”€â”€ robot_runner.py       # æœºå™¨äººè¿è¡Œå™¨
â”‚
â”œâ”€â”€ model/                     # æ¨¡å‹æ¨¡å—
â”‚   â”œâ”€â”€ common/               # é€šç”¨æ¨¡å‹ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ normalizer.py     # æ•°æ®å½’ä¸€åŒ–å™¨
â”‚   â”‚   â”œâ”€â”€ lr_scheduler.py   # å­¦ä¹ ç‡è°ƒåº¦å™¨
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”œâ”€â”€ diffusion/            # Diffusionæ¨¡å‹ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ conditional_unet1d.py  # æ¡ä»¶U-Net 1D
â”‚   â”‚   â”œâ”€â”€ conv1d_components.py  # 1Då·ç§¯ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ ema_model.py          # EMAæ¨¡å‹
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”œâ”€â”€ gnn/                  # å›¾ç¥ç»ç½‘ç»œæ¨¡å—
â”‚   â”‚   â””â”€â”€ robot_graph_network.py # æœºå™¨äººå›¾ç½‘ç»œ
â”‚   â””â”€â”€ vision/               # è§†è§‰ç¼–ç å™¨
â”‚       â””â”€â”€ pointnet_extractor.py  # PointNetç¼–ç å™¨
â”‚
â””â”€â”€ policy/                    # ç­–ç•¥æ¨¡å—
    â”œâ”€â”€ base_policy.py        # åŸºç¡€ç­–ç•¥ç±»
    â”œâ”€â”€ dp3.py                # DP3åŸºç¡€ç­–ç•¥
    â””â”€â”€ dp3_gnn_endpose.py    # DP3-GNN-EndPoseç­–ç•¥
```

---

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½

### 1. ç­–ç•¥æ¨¡å‹ (Policy)

#### DP3 (Diffusion Policy 3D)
- **æ–‡ä»¶**: `policy/dp3.py`
- **åŠŸèƒ½**: åŸºäºDiffusion Modelçš„3Dæœºå™¨äººç­–ç•¥å­¦ä¹ 
- **è¾“å…¥**:
  - ç‚¹äº‘è§‚æµ‹: `[B, To, 1024, 3]` (B=batch, To=è§‚æµ‹å¸§æ•°)
  - (å¯é€‰) Agentä½ç½®: `[B, To, D_pos]`
- **è¾“å‡º**: åŠ¨ä½œåºåˆ— `[B, Ta, Da]` (Ta=åŠ¨ä½œå¸§æ•°, Da=åŠ¨ä½œç»´åº¦)
- **ç‰¹ç‚¹**:
  - ä½¿ç”¨PointNetç¼–ç ç‚¹äº‘
  - ä½¿ç”¨Conditional U-Net 1Dè¿›è¡ŒDiffusioné¢„æµ‹
  - æ”¯æŒDDIMè°ƒåº¦å™¨

#### DP3-EndPose
- **é…ç½®**: `config/robot_dp3_endpose.yaml`
- **åŠŸèƒ½**: é¢„æµ‹æœ«ç«¯æ‰§è¡Œå™¨å§¿æ€ï¼ˆEndPoseï¼‰
- **è¾“å…¥**:
  - ç‚¹äº‘: `[1024, 3]` (xyzåæ ‡)
- **è¾“å‡º**: 
  - EndPose: `[8]` (å·¦xyz+å·¦çˆª+å³xyz+å³çˆª)
- **ç‰¹ç‚¹**:
  - ä¸ä½¿ç”¨agent_pos (`use_agent_pos: false`)
  - åªä½¿ç”¨ç‚¹äº‘é¢„æµ‹EndPose
  - Horizon=8, é¢„æµ‹6å¸§åŠ¨ä½œ

#### DP3-GNN-EndPose
- **æ–‡ä»¶**: `policy/dp3_gnn_endpose.py`
- **é…ç½®**: `config/robot_dp3_gnn_endpose.yaml`
- **åŠŸèƒ½**: ç»“åˆå›¾ç¥ç»ç½‘ç»œå’ŒEndPoseæŒ‡å¯¼çš„ç­–ç•¥å­¦ä¹ 
- **è¾“å…¥**:
  - ç‚¹äº‘: `[1024, 6]` (xyz+é¢œè‰²)
  - Agentä½ç½®: `[14]` (å·¦7+å³7å…³èŠ‚)
  - EndPose Future: `[6, 4]` (æœªæ¥6å¸§çš„EndPose)
- **è¾“å‡º**: 
  - å…³èŠ‚åŠ¨ä½œ: `[14]` (å·¦7+å³7å…³èŠ‚)
- **ç‰¹ç‚¹**:
  - ä½¿ç”¨GNNå»ºæ¨¡å…³èŠ‚å…³ç³»
  - ä½¿ç”¨æœªæ¥EndPoseæŒ‡å¯¼åŠ¨ä½œé¢„æµ‹
  - æ”¯æŒåŒè‡‚åä½œä»»åŠ¡

---

### 2. å›¾ç¥ç»ç½‘ç»œ (GNN)

**æ–‡ä»¶**: `model/gnn/robot_graph_network.py`

#### æ¶æ„ç»„ä»¶

1. **ArmInternalGraphNet** (å•è‡‚å†…éƒ¨å›¾)
   - ç±»å‹: GCN (Graph Convolutional Network)
   - åŠŸèƒ½: å»ºæ¨¡å•ä¸ªæœºæ¢°è‡‚å†…éƒ¨å…³èŠ‚ä¹‹é—´çš„å…³ç³»
   - è¾“å…¥: å…³èŠ‚ç‰¹å¾ `[num_joints, node_dim]`
   - è¾“å‡º: æ›´æ–°åçš„å…³èŠ‚ç‰¹å¾ `[num_joints, hidden_dim]`

2. **JointEndPoseGraphNet** (å…³èŠ‚-EndPoseå…³è”å›¾)
   - ç±»å‹: GAT (Graph Attention Network)
   - åŠŸèƒ½: å»ºæ¨¡å…³èŠ‚ä¸EndPoseä¹‹é—´çš„å…³è”
   - è¾“å…¥: å…³èŠ‚ç‰¹å¾ + EndPose Future `[num_future_frames, endpose_dim]`
   - è¾“å‡º: èåˆEndPoseä¿¡æ¯çš„å…³èŠ‚ç‰¹å¾

3. **BiArmInteractionNet** (åŒè‡‚äº¤äº’ç½‘ç»œ)
   - ç±»å‹: MLP
   - åŠŸèƒ½: å»ºæ¨¡åŒè‡‚ä¹‹é—´çš„äº¤äº’å’Œåè°ƒ
   - è¾“å…¥: å·¦è‡‚ç‰¹å¾ + å³è‡‚ç‰¹å¾
   - è¾“å‡º: èåˆçš„åŒè‡‚ç‰¹å¾

#### RobotGraphNetwork
- **åŠŸèƒ½**: æ•´åˆä¸Šè¿°ä¸‰ä¸ªç»„ä»¶ï¼Œç”ŸæˆGNNç‰¹å¾
- **è¾“å…¥**:
  - `left_qpos`: `[B, 7]` (å·¦è‡‚å…³èŠ‚)
  - `right_qpos`: `[B, 7]` (å³è‡‚å…³èŠ‚)
  - `left_endpose_future`: `[B, 6, 4]` (å·¦è‡‚æœªæ¥EndPose)
  - `right_endpose_future`: `[B, 6, 4]` (å³è‡‚æœªæ¥EndPose)
- **è¾“å‡º**: `[B, gnn_hidden_dim]` (GNNç‰¹å¾)

---

### 3. è§†è§‰ç¼–ç å™¨ (Vision Encoder)

**æ–‡ä»¶**: `model/vision/pointnet_extractor.py`

#### DP3Encoder
- **ç±»å‹**: PointNet
- **åŠŸèƒ½**: ç¼–ç 3Dç‚¹äº‘ä¸ºç‰¹å¾å‘é‡
- **è¾“å…¥**: 
  - ç‚¹äº‘: `[B, To, N, C]` (N=ç‚¹æ•°, C=é€šé“æ•°)
  - (å¯é€‰) Agentä½ç½®: `[B, To, D_pos]`
- **è¾“å‡º**: 
  - ç‚¹äº‘ç‰¹å¾: `[B, To, encoder_output_dim]`
- **ç‰¹ç‚¹**:
  - æ”¯æŒxyzåæ ‡å’Œé¢œè‰²ä¿¡æ¯
  - æ”¯æŒLayerNormå½’ä¸€åŒ–
  - å¯é…ç½®è¾“å‡ºç»´åº¦

---

### 4. Diffusionæ¨¡å‹

**æ–‡ä»¶**: `model/diffusion/conditional_unet1d.py`

#### ConditionalUnet1D
- **åŠŸèƒ½**: 1Dæ¡ä»¶U-Netï¼Œç”¨äºDiffusionè¿‡ç¨‹
- **æ¶æ„**:
  - Downsample: ä¸‹é‡‡æ ·å±‚
  - Upsample: ä¸Šé‡‡æ ·å±‚
  - Residual Blocks: æ®‹å·®å—
  - Cross Attention: äº¤å‰æ³¨æ„åŠ›ï¼ˆç”¨äºæ¡ä»¶æ³¨å…¥ï¼‰
- **è¾“å…¥**:
  - å™ªå£°åŠ¨ä½œ: `[B, horizon, action_dim]`
  - æ—¶é—´æ­¥: `[B]`
  - æ¡ä»¶ç‰¹å¾: `[B, cond_dim]` (ç‚¹äº‘ç‰¹å¾ + GNNç‰¹å¾)
- **è¾“å‡º**: é¢„æµ‹çš„å™ªå£° `[B, horizon, action_dim]`

---

### 5. æ•°æ®é›† (Dataset)

**æ–‡ä»¶**: `dataset/robot_dataset.py`

#### RobotDataset
- **åŠŸèƒ½**: åŠ è½½Zarræ ¼å¼çš„æœºå™¨äººæ•°æ®
- **æ”¯æŒçš„æ•°æ®**:
  - `state`: çŠ¶æ€æ•°æ® (qposæˆ–EndPose)
  - `action`: åŠ¨ä½œæ•°æ®
  - `point_cloud`: ç‚¹äº‘æ•°æ®
  - `left_endpose_future`: å·¦è‡‚æœªæ¥EndPose (GNN-EndPose)
  - `right_endpose_future`: å³è‡‚æœªæ¥EndPose (GNN-EndPose)
- **ç‰¹ç‚¹**:
  - è‡ªåŠ¨æ£€æµ‹å¹¶åŠ è½½EndPose Futureæ•°æ®
  - æ”¯æŒåºåˆ—é‡‡æ · (SequenceSampler)
  - æ”¯æŒæ•°æ®å½’ä¸€åŒ– (LinearNormalizer)

---

### 6. ç¯å¢ƒè¿è¡Œå™¨ (Env Runner)

**æ–‡ä»¶**: `env_runner/robot_runner.py`

#### RobotRunner
- **åŠŸèƒ½**: åœ¨çœŸå®æˆ–ä»¿çœŸç¯å¢ƒä¸­è¿è¡Œç­–ç•¥
- **ç‰¹ç‚¹**:
  - æ”¯æŒæ»šåŠ¨é¢„æµ‹ (Rolling Prediction)
  - æ”¯æŒå¤šæ­¥åŠ¨ä½œæ‰§è¡Œ
  - è®°å½•è½¨è¿¹å’Œæ€§èƒ½æŒ‡æ ‡

---

## ğŸ”§ é…ç½®è¯´æ˜

### DP3-EndPoseé…ç½®

**æ–‡ä»¶**: `config/robot_dp3_endpose.yaml`

```yaml
horizon: 8           # é¢„æµ‹8å¸§åºåˆ—
n_obs_steps: 3        # è¾“å…¥3å¸§è§‚æµ‹
n_action_steps: 6     # æ‰§è¡Œ6å¸§åŠ¨ä½œ

policy:
  use_agent_pos: false  # ä¸ä½¿ç”¨agent_pos
  use_pc_color: false   # åªä½¿ç”¨xyzåæ ‡
  encoder_output_dim: 128
```

### DP3-GNN-EndPoseé…ç½®

**æ–‡ä»¶**: `config/robot_dp3_gnn_endpose.yaml`

```yaml
horizon: 8
n_obs_steps: 3
n_action_steps: 6

policy:
  use_gnn: true
  left_joint_dim: 7
  right_joint_dim: 7
  endpose_dim: 4
  gnn_hidden_dim: 128
  num_graph_layers: 2
```

---

## ğŸ“Š æ•°æ®æµ

### DP3-EndPoseæ•°æ®æµ

```
ç‚¹äº‘è§‚æµ‹ [B, 3, 1024, 3]
    â†“
PointNetç¼–ç å™¨
    â†“
ç‚¹äº‘ç‰¹å¾ [B, 3, 128]
    â†“
Conditional U-Net 1D
    â†“
EndPoseåŠ¨ä½œ [B, 6, 8]
```

### DP3-GNN-EndPoseæ•°æ®æµ

```
ç‚¹äº‘è§‚æµ‹ [B, 3, 1024, 6]
    â†“
PointNetç¼–ç å™¨ â”€â”€â”
                â”‚
å…³èŠ‚ä½ç½® [B, 14] â”€â”€â”¼â”€â”€â†’ RobotGraphNetwork â”€â”€â†’ GNNç‰¹å¾ [B, 128]
                â”‚
EndPose Future â”€â”€â”˜
[B, 6, 4] Ã— 2
    â†“
èåˆç‰¹å¾ [B, cond_dim]
    â†“
Conditional U-Net 1D
    â†“
å…³èŠ‚åŠ¨ä½œ [B, 6, 14]
```

---

## ğŸš€ ä½¿ç”¨ç¤ºä¾‹

### è®­ç»ƒDP3-EndPose

```bash
# 1. å¤„ç†æ•°æ®
bash process_data_endpose.sh stack_blocks_two demo_clean 50

# 2. è®­ç»ƒæ¨¡å‹
python train.py \
    --config-path config \
    --config-name robot_dp3_endpose \
    task_name=stack_blocks_two \
    setting=demo_clean \
    expert_data_num=50
```

### è®­ç»ƒDP3-GNN-EndPose

```bash
# 1. å¤„ç†æ•°æ®
bash process_data_gnn_endpose.sh stack_blocks_two demo_clean 50

# 2. è®­ç»ƒæ¨¡å‹
python train.py \
    --config-path config \
    --config-name robot_dp3_gnn_endpose \
    task_name=stack_blocks_two \
    setting=demo_clean \
    expert_data_num=50
```

---

## ğŸ“ å…³é”®å‚æ•°è¯´æ˜

### æ—¶åºå‚æ•°

- **horizon**: é¢„æµ‹åºåˆ—é•¿åº¦ (é»˜è®¤8)
- **n_obs_steps**: è§‚æµ‹å¸§æ•° (é»˜è®¤3)
- **n_action_steps**: åŠ¨ä½œæ‰§è¡Œå¸§æ•° (é»˜è®¤6)

### Diffusionå‚æ•°

- **num_train_timesteps**: è®­ç»ƒæ—¶é—´æ­¥æ•° (é»˜è®¤100)
- **num_inference_steps**: æ¨ç†æ—¶é—´æ­¥æ•° (é»˜è®¤10)
- **beta_schedule**: å™ªå£°è°ƒåº¦ (é»˜è®¤squaredcos_cap_v2)

### GNNå‚æ•°

- **gnn_hidden_dim**: GNNéšè—å±‚ç»´åº¦ (é»˜è®¤128)
- **num_graph_layers**: GNNå±‚æ•° (é»˜è®¤2)
- **left_joint_dim**: å·¦è‡‚å…³èŠ‚æ•° (é»˜è®¤7)
- **right_joint_dim**: å³è‡‚å…³èŠ‚æ•° (é»˜è®¤7)
- **endpose_dim**: EndPoseç»´åº¦ (é»˜è®¤4)

---

## ğŸ” å…³é”®ç‰¹æ€§

### 1. å¤šæ¨¡æ€è¾“å…¥æ”¯æŒ
- âœ… ç‚¹äº‘è§‚æµ‹ (Point Cloud)
- âœ… å…³èŠ‚ä½ç½® (Joint Position)
- âœ… EndPose Future (æœªæ¥EndPoseæŒ‡å¯¼)

### 2. å›¾ç¥ç»ç½‘ç»œé›†æˆ
- âœ… å•è‡‚å†…éƒ¨å…³èŠ‚å›¾ (GCN)
- âœ… å…³èŠ‚-EndPoseå…³è”å›¾ (GAT)
- âœ… åŒè‡‚äº¤äº’ç½‘ç»œ (MLP)

### 3. Diffusionç­–ç•¥å­¦ä¹ 
- âœ… DDIMè°ƒåº¦å™¨
- âœ… æ¡ä»¶U-Net 1D
- âœ… EMAæ¨¡å‹

### 4. æ•°æ®å¤„ç†
- âœ… Zarræ ¼å¼æ”¯æŒ
- âœ… åºåˆ—é‡‡æ ·
- âœ… æ•°æ®å½’ä¸€åŒ–

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [DP3-EndPoseæ•°æ®å¤„ç†è¯¦è§£](../DP3_EndPose_æ•°æ®å¤„ç†è¯¦è§£.md)
- [DP3-GNN-EndPoseæ¶æ„è¯¦è§£](../DP3_GNN_EndPose_æ¶æ„è¯¦è§£.md)
- [ä»£ç å®¡æŸ¥æŠ¥å‘Š](../docs/ä»£ç å®¡æŸ¥æŠ¥å‘Š.md)
- [å®Œæ•´ä¿®å¤æŠ¥å‘Š](../docs/å®Œæ•´ä¿®å¤æŠ¥å‘Š.md)

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **æ•°æ®å¯¹é½**: ç¡®ä¿è§‚æµ‹å¸§å’ŒåŠ¨ä½œå¸§çš„æ—¶é—´å¯¹é½æ­£ç¡®
2. **EndPose Future**: GNN-EndPoseéœ€è¦EndPose Futureæ•°æ®
3. **æ‰¹æ¬¡å¤§å°**: GNNæ¨¡å‹å¯èƒ½éœ€è¦è¾ƒå°çš„æ‰¹æ¬¡å¤§å°
4. **è®¾å¤‡é…ç½®**: ç¡®ä¿CUDAè®¾å¤‡é…ç½®æ­£ç¡®

---

## ğŸ”„ æ›´æ–°æ—¥å¿—

### 2025-12-22
- âœ… ä¿®å¤DP3-EndPoseæ•°æ®æ—¶é—´å¯¹é½é”™è¯¯
- âœ… æ·»åŠ EndPose Futureæ•°æ®åŠ è½½æ”¯æŒ
- âœ… ä¼˜åŒ–GNNæ¨¡å‹æ¶æ„
- âœ… å®Œå–„æ–‡æ¡£å’Œæ³¨é‡Š

---

**ç»´æŠ¤è€…**: RoboTwin Team  
**è®¸å¯è¯**: MIT


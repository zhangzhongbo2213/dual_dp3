# Diffusion Policy 3D 模型总览（DP3-EndPose / DP3-GNN-EndPose）

> 日期：2025-12-22  
> 适用路径：`diffusion_policy_3d/`

## 0. 当前状态检查（2025-12-22）
- **DP3-EndPose（当前生效）**
  - 输入：点云 `[1024, 3]`，不使用 `agent_pos`
  - 动作：`[8]`（左xyz+左爪+右xyz+右爪）
  - 时序：`horizon=8, n_obs_steps=3, n_action_steps=6`
  - 配置：`config/robot_dp3_endpose.yaml`（`use_agent_pos=false`，点云 `in_channels=3`）
  - 数据处理：`scripts/process_data_endpose.py` 输出 `point_cloud/state/action`
  - Dataset/模型：`dataset/robot_dataset.py` 加载 `state/action/point_cloud`；`policy/dp3.py` 仅用点云

- **DP3-GNN-EndPose（当前保持左右分开 4 维）**
  - 输入：点云 `[1024, 6]`；关节 `agent_pos [14]`；未来 EndPose `left_endpose_future [6, 4]`、`right_endpose_future [6, 4]`
  - 动作：`[14]`（左7+右7关节）
  - 时序：`horizon=8, n_obs_steps=3, n_action_steps=6`
  - 配置：`config/task/gnn_endpose_task.yaml`（左右 `[6,4]`）；`config/robot_dp3_gnn_endpose.yaml` (`endpose_dim=4`)
  - 数据处理：`scripts/process_data_gnn_endpose.py` 生成 `left_endpose_future/right_endpose_future`
  - Dataset：`dataset/robot_dataset.py` 加载左右 endpose_future
  - 模型：`policy/dp3_gnn_endpose.py` 按左右 4 维分别送入 `RobotGraphNetwork`
  - 提示：若需改为单字段 `[6, 8]`（左4+右4），需同步修改配置/数据处理/Dataset/模型并重处理数据

## 1. 模型定位
- **DP3-EndPose**：仅用点云预测末端执行器姿态与夹爪开合（8维：左xyz+左爪+右xyz+右爪），面向单/双臂末端轨迹规划。  
- **DP3-GNN-EndPose**：在DP3基础上引入GNN和未来EndPose引导，输出双臂关节动作（14维），更适合双臂协作与复杂约束。

## 2. 输入 / 输出
### DP3-EndPose
- 观测：点云 `[1024, 3]`（xyz，配置中 `use_agent_pos=false`）
- 动作：`[8]` （左xyz+左爪+右xyz+右爪）
- 时序：`horizon=8, n_obs_steps=3, n_action_steps=6`

### DP3-GNN-EndPose
- 观测：
  - 点云 `[1024, 6]`（xyz+rgb/其他通道）
  - 关节状态 `agent_pos [14]`（左7+右7）
  - 未来EndPose `left/right_endpose_future [6, 4]`（未来6帧 xyz+gripper）
- 动作：`[14]`（左7+右7关节）
- 时序：同上 `horizon=8, n_obs_steps=3, n_action_steps=6`

## 3. 关键组件
- **PointNet 编码器**：`model/vision/pointnet_extractor.py`，编码点云特征供Diffusion/条件层使用。  
- **GNN（仅GNN-EndPose）**：`model/gnn/robot_graph_network.py`  
  - ArmInternalGraphNet（GCN）：建模单臂内部关节关系  
  - JointEndPoseGraphNet（GAT）：关节 ↔ EndPose 关联  
  - BiArmInteractionNet（MLP）：双臂交互融合  
- **Diffusion 核心**：`model/diffusion/conditional_unet1d.py`，条件U-Net 1D + DDIM 调度器。

## 4. 配置入口
- DP3-EndPose：`config/robot_dp3_endpose.yaml`  
  - `use_agent_pos: false`，`use_pc_color: false`，`pointcloud_encoder_cfg.in_channels: 3`
- DP3-GNN-EndPose：`config/robot_dp3_gnn_endpose.yaml`  
  - GNN参数：`use_gnn: true, left/right_joint_dim=7, endpose_dim=4, gnn_hidden_dim=128, num_graph_layers=2`
- 任务形状：
  - `config/task/endpose_task.yaml`（obs点云3通道，action 8维）
  - `config/task/gnn_endpose_task.yaml`（obs点云6通道、agent_pos 14、endpose_future 6x4，action 14维）

## 5. 数据与 Dataset
- 数据生成：`policy/DP3/scripts/process_data_endpose.py` 与 `process_data_gnn_endpose.py`（外部目录）输出 Zarr。  
- Dataset：`dataset/robot_dataset.py`  
  - 自动加载 `state/action/point_cloud`，并检测加载 `left/right_endpose_future`（供GNN使用）。  
  - `SequenceSampler` 负责时序截取与前后填充。

## 6. 训练要点
- 调度器：DDIM `num_train_timesteps=100`，推理步数默认 `10`。  
- 优化：AdamW，`lr=1e-4`，EMA 可选。  
- 批大小：EndPose默认 256；GNN-EndPose默认 64（GNN计算更重，可按显存调整）。

## 7. 推理 / 执行
- 通过 `policy/*.py` 的 `predict_action`：  
  - 归一化 → 点云编码 →（可选）GNN特征 → 条件U-Net Diffusion → 动作。  
  - GNN-EndPose 的 `agent_pos` 仅取首帧，endpose_future 为 `[B, 6, 4]`。

## 8. 快速命令示例
- 训练 EndPose：
  ```bash
  python train.py --config-path config --config-name robot_dp3_endpose \\
    task_name=stack_blocks_two setting=demo_clean expert_data_num=50
  ```
- 训练 GNN-EndPose：
  ```bash
  python train.py --config-path config --config-name robot_dp3_gnn_endpose \\
    task_name=stack_blocks_two setting=demo_clean expert_data_num=50
  ```

## 9. 注意事项
1) 确认数据对齐（EndPose脚本已修复：action 对应 t+1..t+6）。  
2) GNN-EndPose 需确保 Zarr 中含 `left/right_endpose_future`。  
3) horizon=8 但实际执行前6帧，后2帧为平滑填充。  
4) 如使用颜色，请在配置中开启 `use_pc_color` 并调整点云通道。

---

**维护**：RoboTwin 团队  
**路径**：`diffusion_policy_3d/doc/`  

